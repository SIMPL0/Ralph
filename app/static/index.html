<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ralph - Real Estate Business Analysis (v9 - Direct PDF Download)</title> <!-- Updated Title -->
    <style>
        /* === ESTILOS GERAIS === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff; /* Fundo branco inicial */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow: hidden; /* Evita scrollbars durante a intro */
        }

        /* === INTRO ANIMATION CONTAINER === */
        #intro-animation-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #ffffff; /* Fundo branco */
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 1;
            transition: opacity 0.5s ease-out; /* Fade out transition */
        }

        #intro-animation-container.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #intro-logo {
            width: 100px; /* Tamanho inicial pequeno */
            height: 100px;
            opacity: 0;
            animation: introAnimation 3s ease-in-out forwards;
        }

        @keyframes introAnimation {
            0% {
                opacity: 1;
                transform: rotate(0deg) scale(1);
            }
            50% { /* Meio da animação (1.5s) */
                 transform: rotate(360deg) scale(1.25); /* Primeira rotação e crescimento parcial */
            }
            99% { /* Pouco antes do fim (2.97s) */
                opacity: 1;
                transform: rotate(720deg) scale(1.5); /* Segunda rotação e crescimento final */
            }
            100% {
                opacity: 1; /* Keep visible */
                transform: rotate(720deg) scale(1.5); /* Mantém estado final */
            }
        }

        /* === CHAT CONTAINER (Inicialmente oculto) === */
        .chat-container {
            width: 100%;
            max-width: 800px;
            height: 90vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            opacity: 0; /* Começa invisível */
            transform: translateY(20px);
            transition: opacity 1s ease-in, transform 1s ease-out; /* Remove delay */
        }

        .chat-container.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* === CHAT HEADER === */
        .chat-header {
            background: #100f0f;
            padding: 20px;
            color: white;
            text-align: center;
        }
        .ai-name { font-size: 18px; font-weight: 500; margin-bottom: 5px; opacity: 0.9; }
        .chat-header h1 { font-size: 24px; margin-bottom: 5px; }
        .chat-header p { opacity: 0.9; font-size: 14px; }
        .progress-bar { height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; margin-top: 15px; overflow: hidden; }
        .progress-fill { height: 100%; background: white; width: 0%; transition: width 0.3s ease; }

        /* === CHAT MESSAGES === */
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        .message { margin-bottom: 20px; opacity: 0; animation: fadeIn 0.5s ease forwards; }
        @keyframes fadeIn { to { opacity: 1; } }
        .message.bot { display: flex; align-items: flex-start; }
        .message.user { display: flex; justify-content: flex-end; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; background: #100f0f; font-size: 20px; flex-shrink: 0; }
        .message-content { max-width: 80%; padding: 15px 20px; border-radius: 20px; word-wrap: break-word; }
        .message.bot .message-content { background: white; color: #333; border-bottom-left-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .message.user .message-content { background: #100f0f; color: white; border-bottom-right-radius: 5px; max-width: 70%; }

        /* Estilos aprimorados para a resposta da IA */
        .message.bot .analysis-text {
             margin-top: 15px;
             line-height: 1.6;
             border: 1px solid #e0e0e0;
             padding: 25px;
             border-radius: 10px;
             background-color: #fdfdfd;
             font-size: 16px;
             color: #333;
             white-space: pre-wrap; /* Preserva quebras de linha do texto */
             box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }

        /* Estilo para seções do resumo */
        .analysis-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .analysis-section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .analysis-section-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #100f0f;
            font-size: 17px;
        }

        /* === INPUT CONTAINER === */
        .input-container { padding: 20px; background: white; border-top: 1px solid #eee; }
        .input-group { display: flex; gap: 10px; align-items: flex-end; }
        .input-field { flex: 1; padding: 15px; border: 2px solid #e9ecef; border-radius: 25px; font-size: 16px; outline: none; transition: border-color 0.3s ease; resize: none; min-height: 50px; max-height: 120px; color: #333; }
        .input-field:focus { border-color: #555; }
        .input-field:disabled { background-color: #f5f5f5; cursor: not-allowed; }
        .send-btn { width: 50px; height: 50px; border: none; background: #100f0f; border-radius: 50%; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s ease, background-color 0.2s ease; font-size: 20px; flex-shrink: 0; }
        .send-btn:hover:not(:disabled) { transform: scale(1.05); background-color: #333; }
        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; background-color: #100f0f; }

        /* === FILE UPLOAD (Removido visualmente, lógica mantida caso necessário no futuro) === */
        .file-upload { display: none; }

        /* === TYPING INDICATOR === */
        .typing-indicator { display: none; align-items: center; margin-bottom: 20px; }
        .typing-dots { display: flex; gap: 3px; margin-left: 10px; }
        .typing-dot { width: 8px; height: 8px; background: #555; border-radius: 50%; animation: typing 1.4s infinite ease-in-out; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* === BOTÕES INICIAIS e BOTÃO FINALIZAR/DOWNLOAD === */
        .initial-profile-selector {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        .profile-btn {
            padding: 15px 20px; background: #100f0f; color: white; border: none; border-radius: 15px; cursor: pointer; font-size: 16px; transition: transform 0.2s ease, background-color 0.2s ease;
        }
        .profile-btn:hover { transform: translateY(-2px); background-color: #333; }

        .finish-btn { width: 100%; padding: 15px; background: linear-gradient(135deg, #333 0%, #222 100%); color: white; border: none; border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: transform 0.2s ease, background-color 0.2s ease; display: none; }
        .finish-btn:hover:not(:disabled) { transform: translateY(-2px); background: linear-gradient(135deg, #444 0%, #333 100%); }
        .finish-btn:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }

        /* Estilo para o botão de download de PDF (reutiliza .profile-btn) */
        .pdf-download-btn {
            padding: 15px 20px;
            background: #100f0f;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s ease, background-color 0.2s ease;
            margin: 20px auto;
            display: block; /* Para centralizar com margin auto */
            width: fit-content;
        }
        .pdf-download-btn:hover:not(:disabled) { transform: translateY(-2px); background-color: #333; }
        .pdf-download-btn:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }

        /* === OUTROS === */
        .warning { background: #fff3cd; color: #856404; padding: 10px; border-radius: 10px; margin-bottom: 10px; font-size: 14px; text-align: center; }
        .status-message { display: none; margin-top: 10px; text-align: center; color: #555; }

        /* === EMAIL FORM - REMOVIDO === */

    </style>
</head>
<body>

    <!-- Intro Animation -->
    <div id="intro-animation-container">
        <img id="intro-logo" src="intro_animation_logo.png" alt="Loading Logo">
    </div>

    <!-- Chat Container -->
    <div id="chatContainer" class="chat-container">
        <div class="chat-header">
            <span class="ai-name">Ralph AI</span>
            <h1>Real Estate Business Analyzer</h1>
            <p>Let's understand your business better.</p>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
        </div>
        <div id="chatMessages" class="chat-messages">
            <!-- Mensagens do chat serão adicionadas aqui -->
        </div>
        <div class="input-container">
             <!-- Upload de Imagem (Removido visualmente) -->
            <div class="file-upload">
                <label for="imageUpload" class="file-upload-btn">Upload Images (Optional)</label>
                <input type="file" id="imageUpload" accept="image/*" multiple>
                <span style="font-size: 12px; color: #666;"> (<span id="imageCount">0</span>/<span id="maxImages">3</span> uploaded)</span>
            </div>
            <div id="uploadedImagesContainer" class="uploaded-images"></div>
            <div id="limitWarning" class="warning" style="display: none;">Limit reached. Click Finish to get analysis.</div>

            <div class="input-group">
                <textarea id="userInput" class="input-field" placeholder="Type your answer..." rows="1" disabled></textarea>
                <button id="sendBtn" class="send-btn" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </button>
            </div>
            <button id="finishBtn" class="finish-btn" disabled>Click Here for Your Analysis</button>

            <!-- Formulário de Email REMOVIDO -->

            <div id="statusMessage" class="status-message"></div>
        </div>
    </div>

    <script>
        // --- CONFIGURAÇÃO INICIAL ---
        const BASE_URL = 'https://ralph-v68j.onrender.com'; // Base URL do backend
        const ANALYZE_URL = `${BASE_URL}/analyze`; // Endpoint para obter o sumário
        const GENERATE_PDF_URL = `${BASE_URL}/generate-pdf`; // Endpoint para gerar o PDF
        let USER_PROFILE = null; // 'individual', 'employee', 'owner'

        // --- ELEMENTOS DOM ---
        const introAnimationContainer = document.getElementById('intro-animation-container');
        const chatContainer = document.getElementById('chatContainer');
        const chatMessages = document.getElementById('chatMessages');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const progressFill = document.getElementById('progressFill');
        const finishBtn = document.getElementById('finishBtn');
        const statusMessage = document.getElementById('statusMessage');
        // Email form elements removed

        // --- VARIÁVEIS DE ESTADO ---
        let currentQuestionIndex = 0;
        let isFinished = false;
        let chatHistory = [];
        let userAnswers = {}; // Armazena Q&A
        let isTyping = false;
        let questions = []; // Será preenchido com base no perfil
        let userName = ""; // Armazena o nome do usuário

        // --- DEFINIÇÃO DAS PERGUNTAS POR PERFIL (20 perguntas cada) ---
        const questions_individual = [
            { id: 'q1', text: "Hi there! I'm Ralph. To start, what's your name?", key: 'userName', placeholder: 'Enter your name' },
            { id: 'q2', text: "Great, {userName}! As an independent agent, what's your primary focus area? (e.g., residential sales, luxury rentals, commercial leases)", key: 'focusArea', placeholder: 'Describe your main focus' },
            { id: 'q3', text: "Which geographical region or specific neighborhoods do you primarily serve?", key: 'region', placeholder: 'e.g., Downtown Miami, South Beach' },
            { id: 'q4', text: "How long have you been working as an independent real estate agent?", key: 'experienceYears', placeholder: 'e.g., 5 years, 6 months' },
            { id: 'q5', text: "What are your main sources for generating new leads currently? (e.g., referrals, online ads, social media, networking)", key: 'leadSources', placeholder: 'List your primary lead sources' },
            { id: 'q6', text: "Which lead source brings you the highest quality clients, even if not the highest volume?", key: 'qualityLeadSource', placeholder: 'e.g., Referrals from past clients' },
            { id: 'q7', text: "On average, how many hours per week do you dedicate specifically to prospecting and lead generation activities?", key: 'prospectingHours', placeholder: 'Estimate hours per week' },
            { id: 'q8', text: "What CRM or system do you use to manage your contacts and follow-ups?", key: 'crmSystem', placeholder: 'e.g., None, Excel, Specific CRM' },
            { id: 'q9', text: "How do you currently handle transaction management and paperwork?", key: 'transactionManagement', placeholder: 'Describe your process' },
            { id: 'q10', text: "What marketing strategies are you currently employing? (e.g., social media posts, email newsletters, local flyers)", key: 'marketingStrategies', placeholder: 'List your marketing activities' },
            { id: 'q11', text: "What is your average deal size or transaction value?", key: 'avgDealSize', placeholder: 'Enter approximate value' },
            { id: 'q12', text: "How many transactions did you close in the last 12 months?", key: 'transactionsLastYear', placeholder: 'Enter number of transactions' },
            { id: 'q13', text: "What is your process for following up with past clients to encourage repeat business or referrals?", key: 'pastClientFollowup', placeholder: 'Describe your follow-up strategy' },
            { id: 'q14', text: "What tools or software do you use regularly in your business? (e.g., MLS access, e-signature, marketing tools)", key: 'toolsUsed', placeholder: 'List key tools' },
            { id: 'q15', text: "What is the biggest challenge you face in your day-to-day work?", key: 'biggestChallenge', placeholder: 'Describe your main challenge' },
            { id: 'q16', text: "What are your income goals for the next 12 months?", key: 'incomeGoals', placeholder: 'Enter your target income' },
            { id: 'q17', text: "How do you stay updated on market trends and industry changes?", key: 'marketUpdates', placeholder: 'Describe how you stay informed' },
            { id: 'q18', text: "What administrative tasks take up most of your time?", key: 'adminTasks', placeholder: 'List time-consuming admin tasks' },
            { id: 'q19', text: "If you could automate one part of your workflow, what would it be?", key: 'automationWish', placeholder: 'Describe what you would automate' },
            { id: 'q20', text: "What is your unique selling proposition (USP) that differentiates you from other agents?", key: 'usp', placeholder: 'Describe your unique value' }
        ];

        const questions_employee = [
            { id: 'q1', text: "Hi there! I'm Ralph. To start, what's your name?", key: 'userName', placeholder: 'Enter your name' },
            { id: 'q2', text: "Great, {userName}! What is your specific role within the real estate company? (e.g., Sales Agent, Marketing Coordinator, Transaction Manager)", key: 'role', placeholder: 'Describe your role' },
            { id: 'q3', text: "How long have you been working at this company?", key: 'companyTenure', placeholder: 'e.g., 2 years, 10 months' },
            { id: 'q4', text: "What type of real estate does your company primarily focus on? (e.g., residential, commercial, property management)", key: 'companyFocus', placeholder: 'Describe company focus' },
            { id: 'q5', text: "How does the company generate leads for its agents or teams?", key: 'companyLeadGen', placeholder: 'Describe lead generation methods' },
            { id: 'q6', text: "What CRM or internal systems does the company provide for managing clients and tasks?", key: 'companyCRM', placeholder: 'List provided systems' },
            { id: 'q7', text: "What kind of training or professional development opportunities does the company offer?", key: 'companyTraining', placeholder: 'Describe training programs' },
            { id: 'q8', text: "How is communication and collaboration handled within your team or the company?", key: 'teamCommunication', placeholder: 'Describe communication tools/methods' },
            { id: 'q9', text: "What are your primary responsibilities in a typical transaction process?", key: 'transactionResponsibilities', placeholder: 'List your key tasks' },
            { id: 'q10', text: "What marketing support does the company provide for listings or agent branding?", key: 'marketingSupport', placeholder: 'Describe company marketing help' },
            { id: 'q11', text: "How is your performance typically measured or evaluated?", key: 'performanceMetrics', placeholder: 'e.g., Sales volume, client satisfaction' },
            { id: 'q12', text: "What tools or software provided by the company do you use most frequently?", key: 'companyTools', placeholder: 'List frequently used tools' },
            { id: 'q13', text: "What is one process within the company that you feel could be more efficient?", key: 'inefficientProcess', placeholder: 'Identify an area for improvement' },
            { id: 'q14', text: "How satisfied are you with the level of administrative or operational support you receive?", key: 'adminSupportSatisfaction', placeholder: 'Rate satisfaction (e.g., Very satisfied, Neutral)' },
            { id: 'q15', text: "What are your personal career goals within the real estate industry?", key: 'careerGoals', placeholder: 'Describe your aspirations' },
            { id: 'q16', text: "How does the company utilize technology to streamline workflows?", key: 'companyTechnology', placeholder: 'Describe tech usage' },
            { id: 'q17', text: "What is the company culture like?", key: 'companyCulture', placeholder: 'Describe the work environment' },
            { id: 'q18', text: "What is the biggest challenge you face in your current role?", key: 'roleChallenge', placeholder: 'Describe your main challenge' },
            { id: 'q19', text: "If you could suggest one improvement to the company's operations, what would it be?", key: 'suggestedImprovement', placeholder: 'Suggest an operational improvement' },
            { id: 'q20', text: "What aspect of your job do you find most rewarding?", key: 'jobReward', placeholder: 'Describe what you enjoy most' }
        ];

        const questions_owner = [
            { id: 'q1', text: "Hi there! I'm Ralph. To start, what's your name?", key: 'userName', placeholder: 'Enter your name' },
            { id: 'q2', text: "Great, {userName}! What is the name of your real estate business?", key: 'businessName', placeholder: 'Enter your business name' },
            { id: 'q3', text: "How many agents or employees are currently part of your team?", key: 'teamSize', placeholder: 'Enter number of people' },
            { id: 'q4', text: "What is the primary niche or specialization of your business? (e.g., luxury homes, first-time buyers, investment properties)", key: 'businessNiche', placeholder: 'Describe your specialization' },
            { id: 'q5', text: "What geographical areas does your business primarily cover?", key: 'businessRegion', placeholder: 'List main service areas' },
            { id: 'q6', text: "What are the main lead generation strategies your business employs?", key: 'businessLeadGen', placeholder: 'Describe lead gen strategies' },
            { id: 'q7', text: "Which lead generation channel provides the best return on investment (ROI)?", key: 'bestRoiChannel', placeholder: 'Identify the most profitable channel' },
            { id: 'q8', text: "What CRM or technology platform does your business use to manage operations?", key: 'businessCRM', placeholder: 'List primary tech platform' },
            { id: 'q9', text: "How do you handle transaction coordination and compliance across your team?", key: 'transactionCoordination', placeholder: 'Describe your process' },
            { id: 'q10', text: "What marketing initiatives are currently active for your brand?", key: 'businessMarketing', placeholder: 'List current marketing efforts' },
            { id: 'q11', text: "What is your company's average commission split structure with agents?", key: 'commissionSplit', placeholder: 'Describe typical splits' },
            { id: 'q12', text: "What training and support systems do you have in place for your agents?", key: 'agentTraining', placeholder: 'Describe training programs' },
            { id: 'q13', text: "What is your current process for recruiting and retaining agents?", key: 'recruitmentProcess', placeholder: 'Describe your approach' },
            { id: 'q14', text: "How do you track performance metrics for your agents or teams?", key: 'performanceTracking', placeholder: 'Describe tracking methods' },
            { id: 'q15', text: "What is your company's annual revenue growth rate over the past year?", key: 'growthRate', placeholder: 'Enter approximate percentage' },
            { id: 'q16', text: "What are your top business goals for the next 12 months?", key: 'businessGoals', placeholder: 'List your primary goals' },
            { id: 'q17', text: "What is one process in your business that you believe is inefficient or could be improved?", key: 'inefficientProcess', placeholder: 'Identify an area for improvement' },
            { id: 'q18', text: "How much time per week do you personally spend on administrative tasks vs. strategic activities?", key: 'timeAllocation', placeholder: 'e.g., 60% admin, 40% strategic' },
            { id: 'q19', text: "If you could automate one aspect of your business operations, what would it be?", key: 'automationWish', placeholder: 'Describe what you would automate' },
            { id: 'q20', text: "What do you see as the biggest opportunity for growth in your business right now?", key: 'growthOpportunity', placeholder: 'Identify key opportunity' }
        ];

        // --- FUNÇÕES PRINCIPAIS ---

        // Função para mostrar a seleção de perfil inicial
        function showProfileSelection() {
            const profileSelector = document.createElement('div');
            profileSelector.className = 'initial-profile-selector';
            profileSelector.innerHTML = `
                <div class="message bot">
                    <div class="avatar">R</div>
                    <div class="message-content">
                        <p>Hi there! I'm Ralph, your Real Estate Business Analyzer. To provide the most relevant analysis, please select your profile:</p>
                    </div>
                </div>
                <button class="profile-btn" data-profile="individual">I'm an Independent Agent</button>
                <button class="profile-btn" data-profile="employee">I Work for a Real Estate Company</button>
                <button class="profile-btn" data-profile="owner">I Own a Real Estate Business</button>
            `;

            chatMessages.appendChild(profileSelector);

            // Adiciona event listeners para os botões de perfil
            const profileButtons = profileSelector.querySelectorAll('.profile-btn');
            profileButtons.forEach(button => {
                button.addEventListener('click', () => {
                    USER_PROFILE = button.getAttribute('data-profile');
                    console.log(`Perfil selecionado: ${USER_PROFILE}`);

                    // Define as perguntas com base no perfil
                    if (USER_PROFILE === 'individual') questions = questions_individual;
                    else if (USER_PROFILE === 'employee') questions = questions_employee;
                    else if (USER_PROFILE === 'owner') questions = questions_owner;

                    // Remove os botões de seleção
                    profileSelector.remove();

                    // Inicia o questionário
                    askNextQuestion();
                });
            });
        }

        // Função para fazer a próxima pergunta
        function askNextQuestion() {
            if (currentQuestionIndex < questions.length) {
                const question = questions[currentQuestionIndex];
                let questionText = question.text;

                // Substitui {userName} pelo nome do usuário se disponível
                if (userAnswers.userName) {
                    questionText = questionText.replace('{userName}', userAnswers.userName);
                }

                addMessage('bot', questionText);

                // Atualiza a barra de progresso
                updateProgress();

                // Habilita o input para resposta
                userInput.disabled = false;
                userInput.placeholder = question.placeholder;
                sendBtn.disabled = false;
                userInput.focus();

                // Se for a última pergunta, mostra o botão de finalizar
                if (currentQuestionIndex === questions.length - 1) {
                    finishBtn.style.display = 'block';
                }
            } else {
                // Todas as perguntas foram respondidas
                finishBtn.style.display = 'block';
                finishBtn.disabled = false;
                userInput.disabled = true;
                sendBtn.disabled = true;

                addMessage('bot', "Great! I have all the information I need. Click the button below to get your personalized business analysis.");
            }
        }

        // Função para adicionar mensagem ao chat
        function addMessage(sender, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            if (sender === 'bot') {
                // Mensagem do bot
                messageDiv.innerHTML = `
                    <div class="avatar">R</div>
                    <div class="message-content">
                        <p>${content}</p>
                    </div>
                `;
            } else {
                // Mensagem do usuário
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <p>${content}</p>
                    </div>
                `;
            }

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Adiciona ao histórico de chat
            chatHistory.push({
                sender: sender,
                content: content
            });
        }

        // Função para adicionar análise formatada ao chat
        function addAnalysisMessage(content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';

            // Função para formatar o texto em seções (simplificada)
            function formatAnalysisText(text) {
                // Tenta preservar parágrafos e adicionar algum espaçamento
                const paragraphs = text.split('\n\n'); // Divide por parágrafos (dupla quebra de linha)
                let formattedHtml = paragraphs.map(p => {
                    // Tenta identificar títulos (linhas curtas em maiúsculas ou com números)
                    const trimmedP = p.trim();
                    if (trimmedP.length < 60 && (trimmedP === trimmedP.toUpperCase() || /^\d+\.\s/.test(trimmedP))) {
                        return `<div class="analysis-section-title">${trimmedP}</div>`;
                    }
                    // Trata linhas como parágrafos individuais
                    const lines = p.split('\n').map(line => `<p>${line}</p>`).join('');
                    return `<div class="analysis-section-content">${lines}</div>`;
                }).join('<br>'); // Adiciona um espaço entre seções/parágrafos

                return `<div class="analysis-section">${formattedHtml}</div>`;
            }

            // Aplica a formatação
            const formattedHtml = formatAnalysisText(content);

            messageDiv.innerHTML = `
                <div class="avatar">R</div>
                <div class="message-content">
                    <p>Here is your business analysis preview:</p> <!-- Updated message -->
                    <div class="analysis-text">${formattedHtml}</div>
                </div>
            `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Adiciona ao histórico de chat (a análise bruta)
            chatHistory.push({
                sender: 'bot',
                content: content // Store the raw analysis text
            });
        }

        // Função para mostrar indicador de digitação
        function showTypingIndicator() {
            if (document.querySelector('.typing-indicator')) return;

            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="avatar">R</div>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;

            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            typingDiv.style.display = 'flex';
        }

        // Função para esconder indicador de digitação
        function hideTypingIndicator() {
            const typingDiv = document.querySelector('.typing-indicator');
            if (typingDiv) typingDiv.remove();
        }

        // Função para atualizar a barra de progresso
        function updateProgress() {
            const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
            progressFill.style.width = `${progress}%`;
        }

        // Função para enviar resposta do usuário
        function sendUserResponse() {
            if (isTyping) return;

            const userMessage = userInput.value.trim();
            if (!userMessage) return;

            // Adiciona a resposta ao chat
            addMessage('user', userMessage);

            // Armazena a resposta
            const currentQuestion = questions[currentQuestionIndex];
            userAnswers[currentQuestion.key] = userMessage;

            // Se for a primeira pergunta (nome), armazena o nome do usuário
            if (currentQuestion.key === 'userName') {
                userName = userMessage;
            }

            // Limpa o input e desabilita temporariamente
            userInput.value = '';
            userInput.disabled = true;
            sendBtn.disabled = true;

            // Avança para a próxima pergunta
            currentQuestionIndex++;

            // Simula tempo de resposta
            isTyping = true;
            showTypingIndicator();

            setTimeout(() => {
                hideTypingIndicator();
                isTyping = false;
                askNextQuestion();
            }, 1000);
        }

        // <<< MODIFIED finishQuestionnaire function >>>
        function finishQuestionnaire() {
            if (isFinished) return;
            isFinished = true;

            // Desabilita o botão de finalizar
            finishBtn.disabled = true;
            finishBtn.textContent = "Analyzing your business...";

            // Mostra indicador de digitação
            showTypingIndicator();

            // Prepara os dados para enviar ao backend (para o sumário)
            const requestData = {
                userName: userName || "User",
                profile: USER_PROFILE,
                chatHistory: chatHistory,
                // answers: userAnswers // Answers might not be needed if using full chatHistory
            };

            console.log("Enviando dados para análise (sumário):", requestData);

            // Envia os dados para o backend (/analyze endpoint para obter o sumário)
            fetch(ANALYZE_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                if (!response.ok) {
                    // Tenta ler a mensagem de erro do corpo da resposta
                    return response.json().then(errData => {
                        throw new Error(`HTTP error! Status: ${response.status} - ${errData.error || 'Unknown error'}`);
                    }).catch(() => {
                        // Se não conseguir ler o JSON do erro, lança erro genérico
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                // Esconde indicador de digitação
                hideTypingIndicator();

                // Adiciona a análise (sumário) ao chat
                addAnalysisMessage(data.analysis_text);

                // Esconde o botão "Finish"
                finishBtn.style.display = 'none';

                // Adiciona o botão de download do PDF se estiver pronto
                if (data.pdf_ready) {
                    const pdfBtnContainer = document.createElement('div');
                    pdfBtnContainer.style.textAlign = 'center'; // Centraliza o botão
                    pdfBtnContainer.style.marginTop = '15px';

                    const pdfBtn = document.createElement('button');
                    pdfBtn.className = 'pdf-download-btn'; // Usa a nova classe CSS
                    pdfBtn.textContent = 'Download Detailed PDF Report';
                    pdfBtn.onclick = () => {
                        // Chama a nova função para gerar e baixar o PDF
                        generateAndDownloadPDF(pdfBtn); // Passa o botão para desabilitar/reabilitar
                    };

                    pdfBtnContainer.appendChild(pdfBtn);

                    // Adiciona uma mensagem do bot com o botão
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message bot';
                    messageDiv.innerHTML = `
                        <div class="avatar">R</div>
                        <div class="message-content">
                            <p>Your detailed PDF report is ready!</p>
                        </div>
                    `;
                    // Anexa o container do botão após a div da mensagem
                    messageDiv.querySelector('.message-content').appendChild(pdfBtnContainer);

                    chatMessages.appendChild(messageDiv);
                } else {
                    // Se o PDF não estiver pronto (erro na análise do sumário), informa o usuário
                    addMessage('bot', "There was an issue preparing your detailed report. Please contact support.");
                }

                // Rola para o final do chat
                chatMessages.scrollTop = chatMessages.scrollHeight;

                console.log("Análise de sumário recebida. Botão de PDF adicionado (se aplicável).");
            })
            .catch(error => {
                console.error("Erro ao obter análise (sumário):", error);

                // Esconde indicador de digitação
                hideTypingIndicator();

                // Adiciona mensagem de erro
                addMessage('bot', `I'm sorry, there was an error generating your analysis preview: ${error.message}. Please try again later.`);

                // Reseta o botão de finalizar para permitir nova tentativa?
                // Ou talvez esconder? Por enquanto, esconde.
                finishBtn.style.display = 'none';
                isFinished = false; // Permite tentar novamente?
            });
        }

        // <<< NEW generateAndDownloadPDF function >>>
        async function generateAndDownloadPDF(buttonElement) {
            if (buttonElement) buttonElement.disabled = true;
            if (buttonElement) buttonElement.textContent = 'Generating PDF...';

            showTypingIndicator();

            try {
                // Prepara os dados para gerar o PDF
                const requestData = {
                    userName: userName || "User",
                    profile: USER_PROFILE,
                    chatHistory: chatHistory
                };

                console.log("Enviando dados para geração de PDF:", requestData);

                const response = await fetch(GENERATE_PDF_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                hideTypingIndicator(); // Esconde o indicador assim que a resposta chegar

                if (!response.ok) {
                    // Tenta obter a mensagem de erro do corpo JSON
                    let errorMsg = `PDF generation failed with status: ${response.status}`;
                    try {
                        const errData = await response.json();
                        errorMsg = errData.error || errorMsg;
                    } catch (e) {
                        // Ignora se não conseguir parsear o erro JSON
                    }
                    throw new Error(errorMsg);
                }

                // Se a resposta for OK, espera-se um blob (arquivo PDF)
                const blob = await response.blob();

                // Verifica se o blob é realmente um PDF (opcional mas bom)
                if (blob.type !== 'application/pdf') {
                    throw new Error('Received file is not a PDF.');
                }

                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                // Cria um nome de arquivo mais descritivo
                const safeUserName = (userName || 'User').replace(/[^a-zA-Z0-9]/g, '_');
                a.download = `Ralph_Analysis_${safeUserName}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                addMessage('bot', "PDF downloaded successfully! We've also sent a copy to our team for quality assurance.");
                if (buttonElement) buttonElement.textContent = 'Download Again'; // Permite baixar novamente

            } catch (error) {
                console.error("PDF generation error:", error);
                addMessage('bot', `Failed to generate or download PDF: ${error.message}. Please try again or contact support.`);
                if (buttonElement) buttonElement.textContent = 'Retry Download'; // Muda texto do botão em caso de erro
            } finally {
                hideTypingIndicator(); // Garante que o indicador seja removido
                if (buttonElement) buttonElement.disabled = false; // Reabilita o botão
            }
        }

        // <<< REMOVED submitEmail function >>>

        // --- EVENT LISTENERS ---

        // Evento para enviar resposta ao pressionar Enter
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (!userInput.disabled && userInput.value.trim()) {
                    sendUserResponse();
                }
            }
        });

        // Ajusta a altura do textarea conforme o conteúdo
        userInput.addEventListener('input', () => {
            userInput.style.height = 'auto';
            userInput.style.height = (userInput.scrollHeight > 120 ? 120 : userInput.scrollHeight) + 'px';
        });

        // Evento para o botão de enviar
        sendBtn.addEventListener('click', () => {
            if (!userInput.disabled && userInput.value.trim()) {
                sendUserResponse();
            }
        });

        // Evento para o botão de finalizar
        finishBtn.addEventListener('click', finishQuestionnaire);

        // <<< REMOVED Event listener for submitEmailBtn >>>

        // --- INICIALIZAÇÃO ---

        // Inicia a animação de introdução
        setTimeout(() => {
            introAnimationContainer.classList.add('hidden');

            // Mostra o container do chat após a animação
            setTimeout(() => {
                chatContainer.classList.add('visible');

                // Inicia o chat após a transição
                setTimeout(() => {
                    showProfileSelection();
                }, 500);
            }, 500);
        }, 3000); // Duração da animação de introdução
    </script>
</body>
</html>
