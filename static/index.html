<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ralph - Real Estate Business Analysis (v8 - Full Questions)</title>
    <style>
        /* === ESTILOS GERAIS === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff; /* Fundo branco inicial */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow: hidden; /* Evita scrollbars durante a intro */
        }

        /* === INTRO ANIMATION CONTAINER === */
        #intro-animation-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #ffffff; /* Fundo branco */
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 1;
            transition: opacity 0.5s ease-out; /* Fade out transition */
        }

        #intro-animation-container.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #intro-logo {
            width: 100px; /* Tamanho inicial pequeno */
            height: 100px;
            opacity: 0;
            animation: introAnimation 3s ease-in-out forwards;
        }

        @keyframes introAnimation {
            0% {
                opacity: 1;
                transform: rotate(0deg) scale(1);
            }
            50% { /* Meio da animação (1.5s) */
                 transform: rotate(360deg) scale(1.25); /* Primeira rotação e crescimento parcial */
            }
            99% { /* Pouco antes do fim (2.97s) */
                opacity: 1;
                transform: rotate(720deg) scale(1.5); /* Segunda rotação e crescimento final */
            }
            100% {
                opacity: 1; /* Keep visible */
                transform: rotate(720deg) scale(1.5); /* Mantém estado final */
            }
        }

        /* === CHAT CONTAINER (Inicialmente oculto) === */
        .chat-container {
            width: 100%;
            max-width: 800px;
            height: 90vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            opacity: 0; /* Começa invisível */
            transform: translateY(20px);
            transition: opacity 1s ease-in, transform 1s ease-out; /* Remove delay */
        }

        .chat-container.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* === CHAT HEADER === */
        .chat-header {
            background: #100f0f;
            padding: 20px;
            color: white;
            text-align: center;
        }
        .ai-name { font-size: 18px; font-weight: 500; margin-bottom: 5px; opacity: 0.9; }
        .chat-header h1 { font-size: 24px; margin-bottom: 5px; }
        .chat-header p { opacity: 0.9; font-size: 14px; }
        .progress-bar { height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; margin-top: 15px; overflow: hidden; }
        .progress-fill { height: 100%; background: white; width: 0%; transition: width 0.3s ease; }

        /* === CHAT MESSAGES === */
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        .message { margin-bottom: 20px; opacity: 0; animation: fadeIn 0.5s ease forwards; }
        @keyframes fadeIn { to { opacity: 1; } }
        .message.bot { display: flex; align-items: flex-start; }
        .message.user { display: flex; justify-content: flex-end; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; background: #100f0f; font-size: 20px; flex-shrink: 0; }
        .message-content { max-width: 80%; padding: 15px 20px; border-radius: 20px; word-wrap: break-word; }
        .message.bot .message-content { background: white; color: #333; border-bottom-left-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .message.user .message-content { background: #100f0f; color: white; border-bottom-right-radius: 5px; max-width: 70%; }

        /* Estilos aprimorados para a resposta da IA */
        .message.bot .analysis-text {
             margin-top: 15px;
             line-height: 1.6;
             border: 1px solid #e0e0e0;
             padding: 25px;
             border-radius: 10px;
             background-color: #fdfdfd;
             font-size: 16px;
             color: #333;
             white-space: pre-wrap; /* Preserva quebras de linha do texto */
             box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }

        /* Estilo para seções do resumo */
        .analysis-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .analysis-section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .analysis-section-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #100f0f;
            font-size: 17px;
        }

        /* === INPUT CONTAINER === */
        .input-container { padding: 20px; background: white; border-top: 1px solid #eee; }
        .input-group { display: flex; gap: 10px; align-items: flex-end; }
        .input-field { flex: 1; padding: 15px; border: 2px solid #e9ecef; border-radius: 25px; font-size: 16px; outline: none; transition: border-color 0.3s ease; resize: none; min-height: 50px; max-height: 120px; color: #333; }
        .input-field:focus { border-color: #555; }
        .input-field:disabled { background-color: #f5f5f5; cursor: not-allowed; }
        .send-btn { width: 50px; height: 50px; border: none; background: #100f0f; border-radius: 50%; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s ease, background-color 0.2s ease; font-size: 20px; flex-shrink: 0; }
        .send-btn:hover:not(:disabled) { transform: scale(1.05); background-color: #333; }
        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; background-color: #100f0f; }

        /* === FILE UPLOAD (Removido visualmente, lógica mantida caso necessário no futuro) === */
        .file-upload { display: none; }

        /* === TYPING INDICATOR === */
        .typing-indicator { display: none; align-items: center; margin-bottom: 20px; }
        .typing-dots { display: flex; gap: 3px; margin-left: 10px; }
        .typing-dot { width: 8px; height: 8px; background: #555; border-radius: 50%; animation: typing 1.4s infinite ease-in-out; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* === BOTÕES INICIAIS e BOTÃO FINALIZAR === */
        .initial-profile-selector {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        .profile-btn {
            padding: 15px 20px; background: #100f0f; color: white; border: none; border-radius: 15px; cursor: pointer; font-size: 16px; transition: transform 0.2s ease, background-color 0.2s ease;
        }
        .profile-btn:hover { transform: translateY(-2px); background-color: #333; }

        .finish-btn { width: 100%; padding: 15px; background: linear-gradient(135deg, #333 0%, #222 100%); color: white; border: none; border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: transform 0.2s ease, background-color 0.2s ease; display: none; }
        .finish-btn:hover:not(:disabled) { transform: translateY(-2px); background: linear-gradient(135deg, #444 0%, #333 100%); }
        .finish-btn:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }

        /* === OUTROS === */
        .warning { background: #fff3cd; color: #856404; padding: 10px; border-radius: 10px; margin-bottom: 10px; font-size: 14px; text-align: center; }
        .status-message { display: none; margin-top: 10px; text-align: center; color: #555; }

        /* === EMAIL FORM - Melhorado === */
        .email-form {
            margin-top: 25px;
            padding: 20px;
            background-color: #f0f2f5;
            border-radius: 12px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.08);
            display: none;
            border-top: 3px solid #100f0f;
        }

        .email-form-title {
            font-weight: bold;
            margin-bottom: 12px;
            color: #100f0f;
            font-size: 16px;
            text-align: center;
        }

        .email-form-container {
            display: flex;
            gap: 10px;
        }

        .email-form input[type="email"] {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .email-form input[type="email"]:focus {
            border-color: #555;
        }

        .email-form button {
            padding: 12px 20px;
            background: #100f0f;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s ease, background-color 0.2s ease;
        }

        .email-form button:hover {
            transform: translateY(-2px);
            background-color: #333;
        }

        /* Versão responsiva para dispositivos móveis */
        @media (max-width: 768px) {
            .email-form-container {
                flex-direction: column;
            }
            
            .email-form button {
                margin-top: 10px;
            }
        }

    </style>
</head>
<body>

    <!-- Intro Animation -->
    <div id="intro-animation-container">
        <img id="intro-logo" src="intro_animation_logo.png" alt="Loading Logo">
    </div>

    <!-- Chat Container -->
    <div id="chatContainer" class="chat-container">
        <div class="chat-header">
            <span class="ai-name">Ralph AI</span>
            <h1>Real Estate Business Analyzer</h1>
            <p>Let's understand your business better.</p>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
        </div>
        <div id="chatMessages" class="chat-messages">
            <!-- Mensagens do chat serão adicionadas aqui -->
        </div>
        <div class="input-container">
             <!-- Upload de Imagem (Removido visualmente) -->
            <div class="file-upload">
                <label for="imageUpload" class="file-upload-btn">Upload Images (Optional)</label>
                <input type="file" id="imageUpload" accept="image/*" multiple>
                <span style="font-size: 12px; color: #666;"> (<span id="imageCount">0</span>/<span id="maxImages">3</span> uploaded)</span>
            </div>
            <div id="uploadedImagesContainer" class="uploaded-images"></div>
            <div id="limitWarning" class="warning" style="display: none;">Limit reached. Click Finish to get analysis.</div>
            
            <div class="input-group">
                <textarea id="userInput" class="input-field" placeholder="Type your answer..." rows="1" disabled></textarea>
                <button id="sendBtn" class="send-btn" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </button>
            </div>
            <button id="finishBtn" class="finish-btn" disabled>Click Here for Your Analysis</button>
            
            <!-- Formulário de Email (inicialmente oculto) - Melhorado -->
            <div id="emailForm" class="email-form">
                <div class="email-form-title">Get your detailed PDF report</div>
                <div class="email-form-container">
                    <input type="email" id="userEmail" placeholder="Enter your email address" required>
                    <button id="submitEmailBtn">Get Detailed PDF Report</button>
                </div>
            </div>
            
            <div id="statusMessage" class="status-message"></div>
        </div>
    </div>

    <script>
        // --- CONFIGURAÇÃO INICIAL ---
        const BACKEND_URL = 'https://ralph-v68j.onrender.com/analyze';
        const SUBMIT_EMAIL_URL = 'https://ralph-v68j.onrender.com/submit-email';
        let USER_PROFILE = null; // 'individual', 'employee', 'owner'

        // --- ELEMENTOS DOM ---
        const introAnimationContainer = document.getElementById('intro-animation-container');
        const chatContainer = document.getElementById('chatContainer');
        const chatMessages = document.getElementById('chatMessages');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const progressFill = document.getElementById('progressFill');
        const finishBtn = document.getElementById('finishBtn');
        const statusMessage = document.getElementById('statusMessage');
        const emailForm = document.getElementById('emailForm');
        const userEmail = document.getElementById('userEmail');
        const submitEmailBtn = document.getElementById('submitEmailBtn');

        // --- VARIÁVEIS DE ESTADO ---
        let currentQuestionIndex = 0;
        let isFinished = false;
        let chatHistory = [];
        let userAnswers = {}; // Armazena Q&A
        let isTyping = false;
        let questions = []; // Será preenchido com base no perfil
        let userName = ""; // Armazena o nome do usuário

        // --- DEFINIÇÃO DAS PERGUNTAS POR PERFIL (20 perguntas cada) ---
        const questions_individual = [
            { id: 'q1', text: "Hi there! I'm Ralph. To start, what's your name?", key: 'userName', placeholder: 'Enter your name' },
            { id: 'q2', text: "Great, {userName}! As an independent agent, what's your primary focus area? (e.g., residential sales, luxury rentals, commercial leases)", key: 'focusArea', placeholder: 'Describe your main focus' },
            { id: 'q3', text: "Which geographical region or specific neighborhoods do you primarily serve?", key: 'region', placeholder: 'e.g., Downtown Miami, South Beach' },
            { id: 'q4', text: "How long have you been working as an independent real estate agent?", key: 'experienceYears', placeholder: 'e.g., 5 years, 6 months' },
            { id: 'q5', text: "What are your main sources for generating new leads currently? (e.g., referrals, online ads, social media, networking)", key: 'leadSources', placeholder: 'List your primary lead sources' },
            { id: 'q6', text: "Which lead source brings you the highest quality clients, even if not the highest volume?", key: 'qualityLeadSource', placeholder: 'e.g., Referrals from past clients' },
            { id: 'q7', text: "On average, how many hours per week do you dedicate specifically to prospecting and lead generation activities?", key: 'prospectingHours', placeholder: 'Estimate hours per week' },
            { id: 'q8', text: "What tools or software (CRM, marketing tools, etc.) do you currently use to manage your clients and leads?", key: 'toolsUsed', placeholder: 'List software/tools (or None)' },
            { id: 'q9', text: "How satisfied are you with your current tools? What's missing or could be better?", key: 'toolSatisfaction', placeholder: 'Describe satisfaction and gaps' },
            { id: 'q10', text: "Describe your typical process for following up with a new lead.", key: 'followUpProcess', placeholder: 'Steps you take after getting a lead' },
            { id: 'q11', text: "What's the biggest challenge you face in converting leads into actual clients?", key: 'conversionChallenge', placeholder: 'Describe the main difficulty' },
            { id: 'q12', text: "How do you currently manage your schedule and appointments?", key: 'scheduleManagement', placeholder: 'e.g., Google Calendar, paper planner' },
            { id: 'q13', text: "What percentage of your business comes from repeat clients or referrals?", key: 'repeatBusinessPercent', placeholder: 'Estimate percentage' },
            { id: 'q14', text: "How do you stay in touch with past clients?", key: 'pastClientContact', placeholder: 'Describe your methods' },
            { id: 'q15', text: "What's your average commission per transaction?", key: 'averageCommission', placeholder: 'e.g., $8,000, 2.5% of sale price' },
            { id: 'q16', text: "How many transactions did you close in the past 12 months?", key: 'transactionCount', placeholder: 'Enter approximate number' },
            { id: 'q17', text: "What's one skill you'd like to develop further to grow your business?", key: 'skillDevelopment', placeholder: 'e.g., negotiation, social media marketing' },
            { id: 'q18', text: "What are your business goals for the next 12 months?", key: 'businessGoals', placeholder: 'Describe your primary goals' },
            { id: 'q19', text: "If you could automate one aspect of your business, what would it be?", key: 'automationWish', placeholder: 'Describe what you would automate' },
            { id: 'q20', text: "What do you think is your biggest opportunity for growth right now?", key: 'growthOpportunity', placeholder: 'Identify your key opportunity' }
        ];
        const questions_employee = [
            { id: 'q1', text: "Hi there! I'm Ralph. To start, what's your name?", key: 'userName', placeholder: 'Enter your name' },
            { id: 'q2', text: "Great to meet you, {userName}! What's the name of the real estate company you work for?", key: 'companyName', placeholder: 'Enter company name' },
            { id: 'q3', text: "What's your role or position at the company?", key: 'jobRole', placeholder: 'e.g., Agent, Team Lead, Manager' },
            { id: 'q4', text: "How long have you been working at this company?", key: 'tenureYears', placeholder: 'e.g., 3 years, 6 months' },
            { id: 'q5', text: "What is your company's primary focus area? (e.g., residential sales, commercial leasing)", key: 'companyFocus', placeholder: 'Describe main business focus' },
            { id: 'q6', text: "What geographical areas does your company serve?", key: 'serviceArea', placeholder: 'List service areas' },
            { id: 'q7', text: "How many agents or employees work at your company?", key: 'companySize', placeholder: 'Approximate number' },
            { id: 'q8', text: "What CRM or lead management system does your company use?", key: 'companyCRM', placeholder: 'e.g., Salesforce, in-house system' },
            { id: 'q9', text: "What other key software or tools does your company provide?", key: 'companyTools', placeholder: 'List important software/tools' },
            { id: 'q10', text: "How does your company primarily generate leads for agents?", key: 'leadGeneration', placeholder: 'Describe lead generation methods' },
            { id: 'q11', text: "What's your personal approach to converting leads into clients?", key: 'conversionApproach', placeholder: 'Describe your strategy' },
            { id: 'q12', text: "What's the biggest challenge you face in your current role?", key: 'roleChallenge', placeholder: 'Describe your main challenge' },
            { id: 'q13', text: "How does your company handle transaction management and paperwork?", key: 'transactionManagement', placeholder: 'Describe process or tools used' },
            { id: 'q14', text: "What training or professional development does your company provide?", key: 'companyTraining', placeholder: 'Describe available training' },
            { id: 'q15', text: "How are commissions or compensation structured at your company?", key: 'compensationStructure', placeholder: 'Explain the structure' },
            { id: 'q16', text: "How does your company track performance metrics for agents or teams?", key: 'performanceTracking', placeholder: 'Describe tracking methods or tools' },
            { id: 'q17', text: "What is one skill you'd like to develop further to advance in your career?", key: 'skillDevelopment', placeholder: 'Identify a skill to improve' },
            { id: 'q18', text: "What are your career goals for the next 1-2 years?", key: 'careerGoals', placeholder: 'Describe your short-term goals' },
            { id: 'q19', text: "If you could automate one repetitive task in your current role, what would it be?", key: 'automationWish', placeholder: 'Describe a task you wish to automate' },
            { id: 'q20', text: "What do you think is the biggest opportunity for growth or improvement at your company?", key: 'growthOpportunity', placeholder: 'Identify a key opportunity' }
        ];
        const questions_owner = [
            { id: 'q1', text: "Hi there! I'm Ralph. Let's start with your name?", key: 'userName', placeholder: 'Enter your name' },
            { id: 'q2', text: "Great to meet you, {userName}! What's the name of your real estate business?", key: 'businessName', placeholder: 'Enter business name' },
            { id: 'q3', text: "How long have you owned or operated this business?", key: 'businessAge', placeholder: 'e.g., 5 years, 18 months' },
            { id: 'q4', text: "How many agents or employees currently work at your company?", key: 'teamSize', placeholder: 'Enter number of team members' },
            { id: 'q5', text: "What is your company's primary focus area? (e.g., residential sales, commercial, property management)", key: 'businessFocus', placeholder: 'Describe your main business focus' },
            { id: 'q6', text: "What geographical areas does your business serve?", key: 'serviceArea', placeholder: 'List your service areas' },
            { id: 'q7', text: "What CRM or lead management system does your company use?", key: 'companyCRM', placeholder: 'e.g., Salesforce, in-house system, none' },
            { id: 'q8', text: "What other key software or tools does your business rely on?", key: 'businessTools', placeholder: 'List important software/tools' },
            { id: 'q9', text: "How does your company primarily generate new leads?", key: 'leadGeneration', placeholder: 'Describe lead generation methods' },
            { id: 'q10', text: "What is your approximate close rate (percentage of leads that become transactions)?", key: 'closeRate', placeholder: 'Enter approximate percentage' },
            { id: 'q11', text: "What is your company's biggest operational challenge right now?", key: 'operationalChallenge', placeholder: 'Describe your main challenge' },
            { id: 'q12', text: "How does your company handle transaction management and paperwork?", key: 'transactionManagement', placeholder: 'Describe process or tools used' },
            { id: 'q13', text: "What is your current process for recruiting and retaining agents?", key: 'recruitmentProcess', placeholder: 'Describe your approach' },
            { id: 'q14', text: "How do you track performance metrics for your agents or teams?", key: 'performanceTracking', placeholder: 'Describe tracking methods' },
            { id: 'q15', text: "What is your company's annual revenue growth rate over the past year?", key: 'growthRate', placeholder: 'Enter approximate percentage' },
            { id: 'q16', text: "What are your top business goals for the next 12 months?", key: 'businessGoals', placeholder: 'List your primary goals' },
            { id: 'q17', text: "What is one process in your business that you believe is inefficient or could be improved?", key: 'inefficientProcess', placeholder: 'Identify an area for improvement' },
            { id: 'q18', text: "How much time per week do you personally spend on administrative tasks vs. strategic activities?", key: 'timeAllocation', placeholder: 'e.g., 60% admin, 40% strategic' },
            { id: 'q19', text: "If you could automate one aspect of your business operations, what would it be?", key: 'automationWish', placeholder: 'Describe what you would automate' },
            { id: 'q20', text: "What do you see as the biggest opportunity for growth in your business right now?", key: 'growthOpportunity', placeholder: 'Identify key opportunity' }
        ];

        // --- FUNÇÕES PRINCIPAIS ---

        // Função para mostrar a seleção de perfil inicial
        function showProfileSelection() {
            const profileSelector = document.createElement('div');
            profileSelector.className = 'initial-profile-selector';
            profileSelector.innerHTML = `
                <div class="message bot">
                    <div class="avatar">R</div>
                    <div class="message-content">
                        <p>Hi there! I'm Ralph, your Real Estate Business Analyzer. To provide the most relevant analysis, please select your profile:</p>
                    </div>
                </div>
                <button class="profile-btn" data-profile="individual">I'm an Independent Agent</button>
                <button class="profile-btn" data-profile="employee">I Work for a Real Estate Company</button>
                <button class="profile-btn" data-profile="owner">I Own a Real Estate Business</button>
            `;
            
            chatMessages.appendChild(profileSelector);
            
            // Adiciona event listeners para os botões de perfil
            const profileButtons = profileSelector.querySelectorAll('.profile-btn');
            profileButtons.forEach(button => {
                button.addEventListener('click', () => {
                    USER_PROFILE = button.getAttribute('data-profile');
                    console.log(`Perfil selecionado: ${USER_PROFILE}`);
                    
                    // Define as perguntas com base no perfil
                    if (USER_PROFILE === 'individual') questions = questions_individual;
                    else if (USER_PROFILE === 'employee') questions = questions_employee;
                    else if (USER_PROFILE === 'owner') questions = questions_owner;
                    
                    // Remove os botões de seleção
                    profileSelector.remove();
                    
                    // Inicia o questionário
                    askNextQuestion();
                });
            });
        }

        // Função para fazer a próxima pergunta
        function askNextQuestion() {
            if (currentQuestionIndex < questions.length) {
                const question = questions[currentQuestionIndex];
                let questionText = question.text;
                
                // Substitui {userName} pelo nome do usuário se disponível
                if (userAnswers.userName) {
                    questionText = questionText.replace('{userName}', userAnswers.userName);
                }
                
                addMessage('bot', questionText);
                
                // Atualiza a barra de progresso
                updateProgress();
                
                // Habilita o input para resposta
                userInput.disabled = false;
                userInput.placeholder = question.placeholder;
                sendBtn.disabled = false;
                userInput.focus();
                
                // Se for a última pergunta, mostra o botão de finalizar
                if (currentQuestionIndex === questions.length - 1) {
                    finishBtn.style.display = 'block';
                }
            } else {
                // Todas as perguntas foram respondidas
                finishBtn.style.display = 'block';
                finishBtn.disabled = false;
                userInput.disabled = true;
                sendBtn.disabled = true;
                
                addMessage('bot', "Great! I have all the information I need. Click the button below to get your personalized business analysis.");
            }
        }

        // Função para adicionar mensagem ao chat
        function addMessage(sender, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            if (sender === 'bot') {
                // Mensagem do bot
                messageDiv.innerHTML = `
                    <div class="avatar">R</div>
                    <div class="message-content">
                        <p>${content}</p>
                    </div>
                `;
            } else {
                // Mensagem do usuário
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <p>${content}</p>
                    </div>
                `;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Adiciona ao histórico de chat
            chatHistory.push({
                sender: sender,
                content: content
            });
        }

        // Função para adicionar análise formatada ao chat
        function addAnalysisMessage(content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';
            
            // Formata o conteúdo da análise para melhorar a apresentação visual
            // Divide o texto em seções baseadas em quebras de linha e padrões comuns
            let formattedContent = content;
            
            // Função para formatar o texto em seções
            function formatAnalysisText(text) {
                // Identifica possíveis seções no texto
                const sections = [];
                let currentSection = "";
                let currentTitle = "Business Analysis";
                
                // Divide o texto em linhas
                const lines = text.split('\n');
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    // Verifica se é um possível título de seção (linha curta seguida de linha em branco)
                    const isPotentialTitle = line.length > 0 && line.length < 50 && 
                                           (i === 0 || lines[i-1].trim() === '') &&
                                           (i === lines.length-1 || lines[i+1].trim() === '');
                    
                    // Verifica se é um marcador de seção explícito
                    const isExplicitSection = /^(strengths|areas|recommendations|opportunities|conclusion)/i.test(line);
                    
                    if ((isPotentialTitle || isExplicitSection) && currentSection.trim()) {
                        // Salva a seção anterior
                        sections.push({
                            title: currentTitle,
                            content: currentSection.trim()
                        });
                        
                        // Inicia nova seção
                        currentTitle = line;
                        currentSection = "";
                    } else if (line === "---" && currentSection.trim()) {
                        // Trata separadores como fim de seção
                        sections.push({
                            title: currentTitle,
                            content: currentSection.trim()
                        });
                        
                        // Reseta para próxima seção
                        currentTitle = "Conclusion";
                        currentSection = "";
                    } else {
                        // Adiciona linha à seção atual
                        currentSection += line + "\n";
                    }
                }
                
                // Adiciona a última seção
                if (currentSection.trim()) {
                    sections.push({
                        title: currentTitle,
                        content: currentSection.trim()
                    });
                }
                
                // Se não conseguiu identificar seções, retorna o texto original
                if (sections.length <= 1) {
                    return `<div class="analysis-section">
                                <div class="analysis-section-content">${text}</div>
                            </div>`;
                }
                
                // Formata as seções identificadas
                let formattedHtml = "";
                sections.forEach(section => {
                    formattedHtml += `
                        <div class="analysis-section">
                            <div class="analysis-section-title">${section.title}</div>
                            <div class="analysis-section-content">${section.content}</div>
                        </div>
                    `;
                });
                
                return formattedHtml;
            }
            
            // Aplica a formatação
            const formattedHtml = formatAnalysisText(formattedContent);
            
            messageDiv.innerHTML = `
                <div class="avatar">R</div>
                <div class="message-content">
                    <p>Here is your real estate business analysis:</p>
                    <div class="analysis-text">${formattedHtml}</div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Adiciona ao histórico de chat
            chatHistory.push({
                sender: 'bot',
                content: content
            });
        }

        // Função para mostrar indicador de digitação
        function showTypingIndicator() {
            if (document.querySelector('.typing-indicator')) return;
            
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="avatar">R</div>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            typingDiv.style.display = 'flex';
        }

        // Função para esconder indicador de digitação
        function hideTypingIndicator() {
            const typingDiv = document.querySelector('.typing-indicator');
            if (typingDiv) typingDiv.remove();
        }

        // Função para atualizar a barra de progresso
        function updateProgress() {
            const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
            progressFill.style.width = `${progress}%`;
        }

        // Função para enviar resposta do usuário
        function sendUserResponse() {
            if (isTyping) return;
            
            const userMessage = userInput.value.trim();
            if (!userMessage) return;
            
            // Adiciona a resposta ao chat
            addMessage('user', userMessage);
            
            // Armazena a resposta
            const currentQuestion = questions[currentQuestionIndex];
            userAnswers[currentQuestion.key] = userMessage;
            
            // Se for a primeira pergunta (nome), armazena o nome do usuário
            if (currentQuestion.key === 'userName') {
                userName = userMessage;
            }
            
            // Limpa o input e desabilita temporariamente
            userInput.value = '';
            userInput.disabled = true;
            sendBtn.disabled = true;
            
            // Avança para a próxima pergunta
            currentQuestionIndex++;
            
            // Simula tempo de resposta
            isTyping = true;
            showTypingIndicator();
            
            setTimeout(() => {
                hideTypingIndicator();
                isTyping = false;
                askNextQuestion();
            }, 1000);
        }

        // Função para finalizar o questionário e obter análise
        function finishQuestionnaire() {
            if (isFinished) return;
            isFinished = true;
            
            // Desabilita o botão de finalizar
            finishBtn.disabled = true;
            finishBtn.textContent = "Analyzing your business...";
            
            // Mostra indicador de digitação
            showTypingIndicator();
            
            // Prepara os dados para enviar ao backend
            const requestData = {
                userName: userName || "User",
                profile: USER_PROFILE,
                chatHistory: chatHistory,
                answers: userAnswers
            };
            
            console.log("Enviando dados para análise:", requestData);
            
            // Envia os dados para o backend
            fetch(BACKEND_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Esconde indicador de digitação
                hideTypingIndicator();
                
                // Adiciona a análise ao chat
                addAnalysisMessage(data.analysis_text);
                
                // Atualiza o botão de finalizar
                finishBtn.style.display = 'none';
                
                // Se precisar de email, mostra o formulário
                if (data.need_email) {
                    emailForm.style.display = 'block';
                }
                
                // Rola para o final do chat
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                console.log("Transição para o chat concluída");
            })
            .catch(error => {
                console.error("Erro ao obter análise:", error);
                
                // Esconde indicador de digitação
                hideTypingIndicator();
                
                // Adiciona mensagem de erro
                addMessage('bot', "I'm sorry, there was an error generating your analysis. Please try again later.");
                
                // Reseta o botão de finalizar
                finishBtn.disabled = false;
                finishBtn.textContent = "Try Again";
                isFinished = false;
            });
        }

        // Função para enviar email
        function submitEmail() {
            const email = userEmail.value.trim();
            if (!email) {
                alert("Please enter your email address.");
                return;
            }
            
            // Valida o formato do email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert("Please enter a valid email address.");
                return;
            }
            
            // Desabilita o botão de envio
            submitEmailBtn.disabled = true;
            submitEmailBtn.textContent = "Sending...";
            
            // Mostra mensagem de status
            statusMessage.style.display = 'block';
            statusMessage.textContent = "Sending your detailed report...";
            
            // Prepara os dados para enviar ao backend
            const requestData = {
                email: email,
                userName: userName || "User",
                profile: USER_PROFILE,
                chatHistory: chatHistory
            };
            
            console.log("Enviando solicitação de PDF:", requestData);
            
            // Envia os dados para o backend
            fetch(SUBMIT_EMAIL_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Atualiza a mensagem de status
                statusMessage.textContent = "Your detailed report has been sent to your email!";
                
                // Desabilita o formulário de email
                emailForm.style.display = 'none';
                
                // Adiciona mensagem de confirmação
                addMessage('bot', `Great! Your detailed PDF report has been sent to ${email}. Please check your inbox (and spam folder if necessary).`);
                
                // Rola para o final do chat
                chatMessages.scrollTop = chatMessages.scrollHeight;
            })
            .catch(error => {
                console.error("Error submitting email:", error);
                
                // Reseta o botão de envio
                submitEmailBtn.disabled = false;
                submitEmailBtn.textContent = "Get Detailed PDF Report";
                
                // Atualiza a mensagem de status
                statusMessage.textContent = "There was an error sending your report. Please try again.";
                
                // Adiciona mensagem de erro
                addMessage('bot', "I'm sorry, there was an error sending your detailed report. Please try again or contact support if the problem persists.");
            });
        }

        // --- EVENT LISTENERS ---

        // Evento para enviar resposta ao pressionar Enter
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (!userInput.disabled && userInput.value.trim()) {
                    sendUserResponse();
                }
            }
        });

        // Ajusta a altura do textarea conforme o conteúdo
        userInput.addEventListener('input', () => {
            userInput.style.height = 'auto';
            userInput.style.height = (userInput.scrollHeight > 120 ? 120 : userInput.scrollHeight) + 'px';
        });

        // Evento para o botão de enviar
        sendBtn.addEventListener('click', () => {
            if (!userInput.disabled && userInput.value.trim()) {
                sendUserResponse();
            }
        });

        // Evento para o botão de finalizar
        finishBtn.addEventListener('click', finishQuestionnaire);

        // Evento para o botão de enviar email
        submitEmailBtn.addEventListener('click', submitEmail);

        // --- INICIALIZAÇÃO ---
        
        // Inicia a animação de introdução
        setTimeout(() => {
            introAnimationContainer.classList.add('hidden');
            
            // Mostra o container do chat após a animação
            setTimeout(() => {
                chatContainer.classList.add('visible');
                
                // Inicia o chat após a transição
                setTimeout(() => {
                    showProfileSelection();
                }, 500);
            }, 500);
        }, 3000); // Duração da animação de introdução
    </script>
</body>
</html>
