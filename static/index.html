<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ralph - Real Estate Business Analysis (v8 - Full Questions)</title>
    <style>
        /* === ESTILOS GERAIS === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff; /* Fundo branco inicial */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow: hidden; /* Evita scrollbars durante a intro */
        }

        /* === INTRO ANIMATION CONTAINER === */
        #intro-animation-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #ffffff; /* Fundo branco */
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 1;
            transition: opacity 0.5s ease-out; /* Fade out transition */
        }

        #intro-animation-container.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #intro-logo {
            width: 100px; /* Tamanho inicial pequeno */
            height: 100px;
            opacity: 0;
            animation: introAnimation 3s ease-in-out forwards;
        }

        @keyframes introAnimation {
            0% {
                opacity: 1;
                transform: rotate(0deg) scale(1);
            }
            50% { /* Meio da animação (1.5s) */
                 transform: rotate(360deg) scale(1.25); /* Primeira rotação e crescimento parcial */
            }
            99% { /* Pouco antes do fim (2.97s) */
                opacity: 1;
                transform: rotate(720deg) scale(1.5); /* Segunda rotação e crescimento final */
            }
            100% {
                opacity: 1; /* Keep visible */
                transform: rotate(720deg) scale(1.5); /* Mantém estado final */
            }
        }

        /* === CHAT CONTAINER (Inicialmente oculto) === */
        .chat-container {
            width: 100%;
            max-width: 800px;
            height: 90vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            opacity: 0; /* Começa invisível */
            transform: translateY(20px);
            transition: opacity 1s ease-in, transform 1s ease-out; /* Remove delay */
        }

        .chat-container.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* === CHAT HEADER === */
        .chat-header {
            background: #100f0f;
            padding: 20px;
            color: white;
            text-align: center;
        }
        .ai-name { font-size: 18px; font-weight: 500; margin-bottom: 5px; opacity: 0.9; }
        .chat-header h1 { font-size: 24px; margin-bottom: 5px; }
        .chat-header p { opacity: 0.9; font-size: 14px; }
        .progress-bar { height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; margin-top: 15px; overflow: hidden; }
        .progress-fill { height: 100%; background: white; width: 0%; transition: width 0.3s ease; }

        /* === CHAT MESSAGES === */
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        .message { margin-bottom: 20px; opacity: 0; animation: fadeIn 0.5s ease forwards; }
        @keyframes fadeIn { to { opacity: 1; } }
        .message.bot { display: flex; align-items: flex-start; }
        .message.user { display: flex; justify-content: flex-end; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; background: #100f0f; font-size: 20px; flex-shrink: 0; }
        .message-content { max-width: 80%; padding: 15px 20px; border-radius: 20px; word-wrap: break-word; }
        .message.bot .message-content { background: white; color: #333; border-bottom-left-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .message.user .message-content { background: #100f0f; color: white; border-bottom-right-radius: 5px; max-width: 70%; }

        /* Estilos para a resposta da IA (agora texto plano) */
        .message.bot .analysis-text {
             margin-top: 15px;
             line-height: 1.6;
             border: 1px solid #e0e0e0;
             padding: 20px;
             border-radius: 10px;
             background-color: #fdfdfd;
             font-size: 16px;
             color: #333;
             white-space: pre-wrap; /* Preserva quebras de linha do texto */
        }

        /* === INPUT CONTAINER === */
        .input-container { padding: 20px; background: white; border-top: 1px solid #eee; }
        .input-group { display: flex; gap: 10px; align-items: flex-end; }
        .input-field { flex: 1; padding: 15px; border: 2px solid #e9ecef; border-radius: 25px; font-size: 16px; outline: none; transition: border-color 0.3s ease; resize: none; min-height: 50px; max-height: 120px; color: #333; }
        .input-field:focus { border-color: #555; }
        .input-field:disabled { background-color: #f5f5f5; cursor: not-allowed; }
        .send-btn { width: 50px; height: 50px; border: none; background: #100f0f; border-radius: 50%; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s ease, background-color 0.2s ease; font-size: 20px; flex-shrink: 0; }
        .send-btn:hover:not(:disabled) { transform: scale(1.05); background-color: #333; }
        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; background-color: #100f0f; }

        /* === FILE UPLOAD (Removido visualmente, lógica mantida caso necessário no futuro) === */
        .file-upload { display: none; }

        /* === TYPING INDICATOR === */
        .typing-indicator { display: none; align-items: center; margin-bottom: 20px; }
        .typing-dots { display: flex; gap: 3px; margin-left: 10px; }
        .typing-dot { width: 8px; height: 8px; background: #555; border-radius: 50%; animation: typing 1.4s infinite ease-in-out; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* === BOTÕES INICIAIS e BOTÃO FINALIZAR === */
        .initial-profile-selector {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        .profile-btn {
            padding: 15px 20px; background: #100f0f; color: white; border: none; border-radius: 15px; cursor: pointer; font-size: 16px; transition: transform 0.2s ease, background-color 0.2s ease;
        }
        .profile-btn:hover { transform: translateY(-2px); background-color: #333; }

        .finish-btn { width: 100%; padding: 15px; background: linear-gradient(135deg, #333 0%, #222 100%); color: white; border: none; border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: transform 0.2s ease, background-color 0.2s ease; display: none; }
        .finish-btn:hover:not(:disabled) { transform: translateY(-2px); background: linear-gradient(135deg, #444 0%, #333 100%); }
        .finish-btn:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }

        /* === OUTROS === */
        .warning { background: #fff3cd; color: #856404; padding: 10px; border-radius: 10px; margin-bottom: 10px; font-size: 14px; text-align: center; }
        .status-message { display: none; margin-top: 10px; text-align: center; color: #555; }

        /* === EMAIL FORM === */
        .email-form {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }

        .email-form-container {
            display: flex;
            gap: 10px;
        }

        .email-form input[type="email"] {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .email-form input[type="email"]:focus {
            border-color: #555;
        }

        .email-form button {
            padding: 12px 20px;
            background: #100f0f;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s ease, background-color 0.2s ease;
        }

        .email-form button:hover {
            transform: translateY(-2px);
            background-color: #333;
        }

        /* Versão responsiva para dispositivos móveis */
        @media (max-width: 768px) {
            .email-form-container {
                flex-direction: column;
            }
            
            .email-form button {
                margin-top: 10px;
            }
        }

    </style>
</head>
<body>

    <!-- Intro Animation -->
    <div id="intro-animation-container">
        <img id="intro-logo" src="intro_animation_logo.png" alt="Loading Logo">
    </div>

    <!-- Chat Container -->
    <div id="chatContainer" class="chat-container">
        <div class="chat-header">
            <span class="ai-name">Ralph AI</span>
            <h1>Real Estate Business Analyzer</h1>
            <p>Let's understand your business better.</p>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
        </div>
        <div id="chatMessages" class="chat-messages">
            <!-- Mensagens do chat serão adicionadas aqui -->
        </div>
        <div class="input-container">
             <!-- Upload de Imagem (Removido visualmente) -->
            <div class="file-upload">
                <label for="imageUpload" class="file-upload-btn">Upload Images (Optional)</label>
                <input type="file" id="imageUpload" accept="image/*" multiple>
                <span style="font-size: 12px; color: #666;"> (<span id="imageCount">0</span>/<span id="maxImages">3</span> uploaded)</span>
            </div>
            <div id="uploadedImagesContainer" class="uploaded-images"></div>
            <div id="limitWarning" class="warning" style="display: none;">Limit reached. Click Finish to get analysis.</div>
            
            <div class="input-group">
                <textarea id="userInput" class="input-field" placeholder="Type your answer..." rows="1" disabled></textarea>
                <button id="sendBtn" class="send-btn" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </button>
            </div>
            <button id="finishBtn" class="finish-btn" disabled>Click Here for Your Analysis</button>
            
            <!-- Formulário de Email (inicialmente oculto) -->
            <div id="emailForm" class="email-form">
                <div class="email-form-container">
                    <input type="email" id="userEmail" placeholder="Enter your email address" required>
                    <button id="submitEmailBtn">Get Detailed PDF Report</button>
                </div>
            </div>
            
            <div id="statusMessage" class="status-message"></div>
        </div>
    </div>

    <script>
        // --- CONFIGURAÇÃO INICIAL ---
        const BACKEND_URL = 'https://ralph-v68j.onrender.com/analyze';
        const SUBMIT_EMAIL_URL = 'https://ralph-v68j.onrender.com/submit-email';
        let USER_PROFILE = null; // 'individual', 'employee', 'owner'

        // --- ELEMENTOS DOM ---
        const introAnimationContainer = document.getElementById('intro-animation-container');
        const chatContainer = document.getElementById('chatContainer');
        const chatMessages = document.getElementById('chatMessages');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const progressFill = document.getElementById('progressFill');
        const finishBtn = document.getElementById('finishBtn');
        const statusMessage = document.getElementById('statusMessage');
        const emailForm = document.getElementById('emailForm');
        const userEmail = document.getElementById('userEmail');
        const submitEmailBtn = document.getElementById('submitEmailBtn');

        // --- VARIÁVEIS DE ESTADO ---
        let currentQuestionIndex = 0;
        let isFinished = false;
        let chatHistory = [];
        let userAnswers = {}; // Armazena Q&A
        let isTyping = false;
        let questions = []; // Será preenchido com base no perfil
        let userName = ""; // Armazena o nome do usuário

        // --- DEFINIÇÃO DAS PERGUNTAS POR PERFIL (20 perguntas cada) ---
        const questions_individual = [
            { id: 'q1', text: "Hi there! I'm Ralph. To start, what's your name?", key: 'userName', placeholder: 'Enter your name' },
            { id: 'q2', text: "Great, {userName}! As an independent agent, what's your primary focus area? (e.g., residential sales, luxury rentals, commercial leases)", key: 'focusArea', placeholder: 'Describe your main focus' },
            { id: 'q3', text: "Which geographical region or specific neighborhoods do you primarily serve?", key: 'region', placeholder: 'e.g., Downtown Miami, South Beach' },
            { id: 'q4', text: "How long have you been working as an independent real estate agent?", key: 'experienceYears', placeholder: 'e.g., 5 years, 6 months' },
            { id: 'q5', text: "What are your main sources for generating new leads currently? (e.g., referrals, online ads, social media, networking)", key: 'leadSources', placeholder: 'List your primary lead sources' },
            { id: 'q6', text: "Which lead source brings you the highest quality clients, even if not the highest volume?", key: 'qualityLeadSource', placeholder: 'e.g., Referrals from past clients' },
            { id: 'q7', text: "On average, how many hours per week do you dedicate specifically to prospecting and lead generation activities?", key: 'prospectingHours', placeholder: 'Estimate hours per week' },
            { id: 'q8', text: "What tools or software (CRM, marketing tools, etc.) do you currently use to manage your clients and leads?", key: 'toolsUsed', placeholder: 'List software/tools (or None)' },
            { id: 'q9', text: "How satisfied are you with your current tools? What's missing or could be better?", key: 'toolSatisfaction', placeholder: 'Describe satisfaction and gaps' },
            { id: 'q10', text: "Describe your typical process for following up with a new lead.", key: 'followUpProcess', placeholder: 'Steps you take after getting a lead' },
            { id: 'q11', text: "What's the biggest challenge you face in converting leads into actual clients?", key: 'conversionChallenge', placeholder: 'Describe the main difficulty' },
            { id: 'q12', text: "How do you currently manage your schedule and appointments?", key: 'scheduleManagement', placeholder: 'e.g., Google Calendar, specific app, paper diary' },
            { id: 'q13', text: "Which administrative task takes up the most significant portion of your non-selling time? (e.g., paperwork, scheduling viewings, marketing prep)", key: 'adminTimeSink', placeholder: 'Identify the most time-consuming task' },
            { id: 'q14', text: "How do you stay updated on market trends and property values in your area?", key: 'marketKnowledgeSource', placeholder: 'e.g., MLS data, industry reports, networking' },
            { id: 'q15', text: "What is your strategy for marketing your listings or yourself as an agent?", key: 'marketingStrategy', placeholder: 'Describe your marketing approach' },
            { id: 'q16', text: "What percentage of your business comes from repeat clients or referrals?", key: 'repeatBusinessPercentage', placeholder: 'Estimate percentage (e.g., 30%)' },
            { id: 'q17', text: "What is one skill you'd like to improve to grow your business further? (e.g., negotiation, digital marketing, video creation)", key: 'skillImprovement', placeholder: 'Identify a skill to develop' },
            { id: 'q18', text: "How do you handle transaction management and paperwork for closings?", key: 'transactionManagement', placeholder: 'Describe your process or tools used' },
            { id: 'q19', text: "What is your income goal for the next 12 months?", key: 'incomeGoal', placeholder: 'Enter your target income' },
            { id: 'q20', text: "Thinking about all the tasks you do, if you could magically automate one repetitive part of your work to free up time, what would it be?", key: 'automationWish', placeholder: 'e.g., Sending market updates to leads' }
        ];
        const questions_employee = [
            { id: 'q1', text: "Hi there! I'm Ralph. Let's start with your name?", key: 'userName', placeholder: 'Enter your name' },
            { id: 'q2', text: "Nice to meet you, {userName}! What's the name of the real estate company or brokerage you work for?", key: 'companyName', placeholder: 'Enter company name' },
            { id: 'q3', text: "What is your specific role within the company? (e.g., Sales Agent, Team Lead, Marketing Coordinator, Transaction Coordinator)", key: 'role', placeholder: 'Describe your role' },
            { id: 'q4', text: "How long have you been working in this role?", key: 'experienceYears', placeholder: 'e.g., 3 years, 6 months' },
            { id: 'q5', text: "Approximately how many agents or employees work at your company?", key: 'companySize', placeholder: 'Enter approximate number' },
            { id: 'q6', text: "What CRM or lead management system does your company use?", key: 'companyCRM', placeholder: 'e.g., Salesforce, in-house system, none' },
            { id: 'q7', text: "How would you rate the effectiveness of your current CRM or lead management system on a scale of 1-10?", key: 'crmRating', placeholder: 'Enter a number 1-10' },
            { id: 'q8', text: "What are your main responsibilities in your current role?", key: 'responsibilities', placeholder: 'List your key responsibilities' },
            { id: 'q9', text: "Which of your responsibilities takes up the most time?", key: 'timeConsumingTask', placeholder: 'Describe the most time-consuming task' },
            { id: 'q10', text: "What tools or software do you personally use most frequently in your daily work?", key: 'personalTools', placeholder: 'List tools/software you use regularly' },
            { id: 'q11', text: "What is the biggest challenge you face in your current role?", key: 'biggestChallenge', placeholder: 'Describe your main challenge' },
            { id: 'q12', text: "How does your company currently handle transaction management and paperwork?", key: 'transactionManagement', placeholder: 'Describe the process or tools used' },
            { id: 'q13', text: "How does your team or company communicate internally?", key: 'internalCommunication', placeholder: 'e.g., Slack, email, meetings, etc.' },
            { id: 'q14', text: "How does your company generate most of its leads?", key: 'leadGeneration', placeholder: 'Describe lead generation methods' },
            { id: 'q15', text: "What is one process at your company that you think could be improved?", key: 'processImprovement', placeholder: 'Identify an inefficient process' },
            { id: 'q16', text: "How does your company track performance metrics for agents or teams?", key: 'performanceTracking', placeholder: 'Describe tracking methods or tools' },
            { id: 'q17', text: "What is one skill you'd like to develop further to advance in your career?", key: 'skillDevelopment', placeholder: 'Identify a skill to improve' },
            { id: 'q18', text: "What are your career goals for the next 1-2 years?", key: 'careerGoals', placeholder: 'Describe your short-term goals' },
            { id: 'q19', text: "If you could automate one repetitive task in your current role, what would it be?", key: 'automationWish', placeholder: 'Describe a task you wish to automate' },
            { id: 'q20', text: "What do you think is the biggest opportunity for growth or improvement at your company?", key: 'growthOpportunity', placeholder: 'Identify a key opportunity' }
        ];
        const questions_owner = [
            { id: 'q1', text: "Hi there! I'm Ralph. Let's start with your name?", key: 'userName', placeholder: 'Enter your name' },
            { id: 'q2', text: "Great to meet you, {userName}! What's the name of your real estate business?", key: 'businessName', placeholder: 'Enter business name' },
            { id: 'q3', text: "How long have you owned or operated this business?", key: 'businessAge', placeholder: 'e.g., 5 years, 18 months' },
            { id: 'q4', text: "How many agents or employees currently work at your company?", key: 'teamSize', placeholder: 'Enter number of team members' },
            { id: 'q5', text: "What is your company's primary focus area? (e.g., residential sales, commercial, property management)", key: 'businessFocus', placeholder: 'Describe your main business focus' },
            { id: 'q6', text: "What geographical areas does your business serve?", key: 'serviceArea', placeholder: 'List your service areas' },
            { id: 'q7', text: "What CRM or lead management system does your company use?", key: 'companyCRM', placeholder: 'e.g., Salesforce, in-house system, none' },
            { id: 'q8', text: "What other key software or tools does your business rely on?", key: 'businessTools', placeholder: 'List important software/tools' },
            { id: 'q9', text: "How does your company primarily generate new leads?", key: 'leadGeneration', placeholder: 'Describe lead generation methods' },
            { id: 'q10', text: "What is your approximate close rate (percentage of leads that become transactions)?", key: 'closeRate', placeholder: 'Enter approximate percentage' },
            { id: 'q11', text: "What is your company's biggest operational challenge right now?", key: 'operationalChallenge', placeholder: 'Describe your main challenge' },
            { id: 'q12', text: "How does your company handle transaction management and paperwork?", key: 'transactionManagement', placeholder: 'Describe process or tools used' },
            { id: 'q13', text: "What is your current process for recruiting and retaining agents?", key: 'recruitmentProcess', placeholder: 'Describe your approach' },
            { id: 'q14', text: "How do you track performance metrics for your agents or teams?", key: 'performanceTracking', placeholder: 'Describe tracking methods' },
            { id: 'q15', text: "What is your company's annual revenue growth rate over the past year?", key: 'growthRate', placeholder: 'Enter approximate percentage' },
            { id: 'q16', text: "What are your top business goals for the next 12 months?", key: 'businessGoals', placeholder: 'List your primary goals' },
            { id: 'q17', text: "What is one process in your business that you believe is inefficient or could be improved?", key: 'inefficientProcess', placeholder: 'Identify an area for improvement' },
            { id: 'q18', text: "How much time per week do you personally spend on administrative tasks vs. strategic activities?", key: 'timeAllocation', placeholder: 'e.g., 60% admin, 40% strategic' },
            { id: 'q19', text: "If you could automate one aspect of your business operations, what would it be?", key: 'automationWish', placeholder: 'Describe what you would automate' },
            { id: 'q20', text: "What do you see as the biggest opportunity for growth in your business right now?", key: 'growthOpportunity', placeholder: 'Identify key opportunity' }
        ];

        // --- FUNÇÕES PRINCIPAIS ---

        // Função para mostrar a seleção de perfil inicial
        function showProfileSelection() {
            const profileSelector = document.createElement('div');
            profileSelector.className = 'initial-profile-selector';
            profileSelector.innerHTML = `
                <div class="message bot">
                    <div class="avatar">R</div>
                    <div class="message-content">
                        <p>Hi there! I'm Ralph, your Real Estate Business Analyzer. To provide the most relevant analysis, please select your profile:</p>
                    </div>
                </div>
                <button class="profile-btn" data-profile="individual">I'm an Independent Agent</button>
                <button class="profile-btn" data-profile="employee">I Work for a Real Estate Company</button>
                <button class="profile-btn" data-profile="owner">I Own a Real Estate Business</button>
            `;
            
            chatMessages.appendChild(profileSelector);
            
            // Adiciona event listeners para os botões de perfil
            const profileButtons = profileSelector.querySelectorAll('.profile-btn');
            profileButtons.forEach(button => {
                button.addEventListener('click', () => {
                    USER_PROFILE = button.getAttribute('data-profile');
                    console.log(`Perfil selecionado: ${USER_PROFILE}`);
                    
                    // Define as perguntas com base no perfil
                    if (USER_PROFILE === 'individual') questions = questions_individual;
                    else if (USER_PROFILE === 'employee') questions = questions_employee;
                    else if (USER_PROFILE === 'owner') questions = questions_owner;
                    
                    // Remove os botões de seleção
                    profileSelector.remove();
                    
                    // Inicia o questionário
                    askNextQuestion();
                });
            });
        }

        // Função para fazer a próxima pergunta
        function askNextQuestion() {
            if (currentQuestionIndex < questions.length) {
                const question = questions[currentQuestionIndex];
                let questionText = question.text;
                
                // Substitui {userName} pelo nome do usuário se disponível
                if (userAnswers.userName) {
                    questionText = questionText.replace('{userName}', userAnswers.userName);
                }
                
                addMessage('bot', questionText);
                
                // Atualiza a barra de progresso
                updateProgress();
                
                // Habilita o input para resposta
                userInput.disabled = false;
                userInput.placeholder = question.placeholder;
                sendBtn.disabled = false;
                userInput.focus();
                
                // Se for a última pergunta, mostra o botão de finalizar
                if (currentQuestionIndex === questions.length - 1) {
                    finishBtn.style.display = 'block';
                }
            } else {
                // Todas as perguntas foram respondidas
                finishBtn.style.display = 'block';
                finishBtn.disabled = false;
                userInput.disabled = true;
                sendBtn.disabled = true;
                
                addMessage('bot', "Great! I have all the information I need. Click the button below to get your personalized business analysis.");
            }
        }

        // Função para processar a entrada do usuário
        function handleUserInput() {
            if (userInput.disabled || !userInput.value.trim()) return;
            
            const userMessage = userInput.value.trim();
            addMessage('user', userMessage);
            
            // Armazena a resposta
            const currentQuestion = questions[currentQuestionIndex];
            userAnswers[currentQuestion.key] = userMessage;
            
            // Se for a primeira pergunta (nome), armazena o nome do usuário
            if (currentQuestion.key === 'userName') {
                userName = userMessage;
            }
            
            // Limpa e desabilita o input
            userInput.value = '';
            userInput.style.height = 'auto';
            userInput.disabled = true;
            sendBtn.disabled = true;
            
            // Avança para a próxima pergunta
            currentQuestionIndex++;
            
            // Simula o bot digitando
            simulateTyping();
        }

        // Função para simular o bot digitando
        function simulateTyping() {
            if (isTyping) return;
            
            isTyping = true;
            
            // Cria o indicador de digitação
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.innerHTML = `
                <div class="avatar">R</div>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            
            chatMessages.appendChild(typingIndicator);
            typingIndicator.style.display = 'flex';
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Define um tempo aleatório para "digitação"
            const typingTime = Math.floor(Math.random() * 1000) + 1000; // 1-2 segundos
            
            setTimeout(() => {
                typingIndicator.remove();
                isTyping = false;
                askNextQuestion();
            }, typingTime);
        }

        // Função para adicionar mensagem ao chat
        function addMessage(sender, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            if (sender === 'bot') {
                messageDiv.innerHTML = `
                    <div class="avatar">R</div>
                    <div class="message-content">${content}</div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="message-content">${content}</div>
                `;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Adiciona ao histórico do chat
            chatHistory.push({
                sender: sender,
                content: content
            });
        }

        // Função para atualizar a barra de progresso
        function updateProgress() {
            const progress = ((currentQuestionIndex) / questions.length) * 100;
            progressFill.style.width = `${progress}%`;
        }

        // Função para escapar HTML (segurança)
        function escapeHTML(str) {
            return str.replace(/[&<>'"]/g, 
                tag => ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    "'": '&#39;',
                    '"': '&quot;'
                }[tag]));
        }

        // Função para obter a análise
        async function getAnalysis() {
            if (isFinished) return;
            
            finishBtn.disabled = true;
            finishBtn.textContent = 'Analyzing...';
            statusMessage.textContent = 'Preparing analysis...';
            statusMessage.style.display = 'block';
            
            try {
                // Prepara os dados para enviar
                const dataToSend = {
                    userName: userAnswers.userName || "User",
                    profile: USER_PROFILE,
                    chatHistory: chatHistory
                };
                
                console.log("Enviando dados para análise:", dataToSend);
                
                // Envia para o backend
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSend),
                });

                statusMessage.textContent = 'Processing analysis...';

                if (!response.ok) {
                    let errorMsg = `HTTP error! status: ${response.status} ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        errorMsg = errorData.analysis_text || errorData.error || JSON.stringify(errorData);
                    } catch (jsonError) {
                         try { errorMsg = await response.text(); } catch (textError) { /* ignore */ }
                    }
                     throw new Error(errorMsg);
                }

                const responseText = await response.text(); // Read as text first
                if (!responseText) {
                    throw new Error("Received empty response from server.");
                }

                const result = JSON.parse(responseText); // Parse text to JSON

                statusMessage.textContent = 'Analysis complete!';
                setTimeout(() => { statusMessage.style.display = 'none'; }, 2000);

                // Adiciona a análise (texto plano) como mensagem do bot
                addMessage('bot', result.analysis_text || "Analysis received, but content is empty.");
                finishBtn.textContent = 'Analysis Complete!';
                finishBtn.style.display = 'none'; // Esconde o botão após análise
                
                // Verifica se precisa solicitar o email
                if (result.need_email === true) {
                    // Mostra o formulário de email
                    emailForm.style.display = 'block';
                    // Rola para o formulário
                    emailForm.scrollIntoView({ behavior: 'smooth' });
                }

            } catch (error) {
                console.error('Error fetching analysis:', error);
                statusMessage.textContent = 'Error during analysis.';
                addMessage('bot', `<div class="analysis-text"><strong>Analysis Error</strong><br>Sorry, an error occurred: ${escapeHTML(error.message || 'Unknown error')}<br>Please check the console or try again later.</div>`);
                finishBtn.textContent = 'Analysis Failed - Try Again?'; // Permite tentar novamente
                finishBtn.disabled = false; // Reabilita o botão em caso de erro
            }
        }
        
        // Função para enviar o email e solicitar o PDF
        async function submitEmail() {
            const email = userEmail.value.trim();
            
            // Validação básica de email
            if (!email || !email.includes('@') || !email.includes('.')) {
                alert('Please enter a valid email address');
                return;
            }
            
            // Desabilita o botão e mostra status
            submitEmailBtn.disabled = true;
            submitEmailBtn.textContent = 'Sending...';
            statusMessage.textContent = 'Sending your report...';
            statusMessage.style.display = 'block';
            
            try {
                // Prepara os dados para enviar
                const dataToSend = {
                    email: email,
                    userName: userAnswers.userName || "User",
                    profile: USER_PROFILE,
                    chatHistory: chatHistory
                };
                
                console.log("Enviando solicitação de PDF:", dataToSend);
                
                // Envia para o backend
                const response = await fetch(SUBMIT_EMAIL_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSend),
                });
                
                if (!response.ok) {
                    let errorMsg = `HTTP error! status: ${response.status} ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        errorMsg = errorData.message || errorData.error || JSON.stringify(errorData);
                    } catch (jsonError) {
                        try { errorMsg = await response.text(); } catch (textError) { /* ignore */ }
                    }
                    throw new Error(errorMsg);
                }
                
                const result = await response.json();
                
                // Esconde o formulário
                emailForm.style.display = 'none';
                
                // Mostra mensagem de sucesso
                statusMessage.textContent = 'Report sent successfully!';
                setTimeout(() => { statusMessage.style.display = 'none'; }, 3000);
                
                // Adiciona mensagem de confirmação
                addMessage('bot', `Great! Your detailed PDF report has been sent to ${email}. Please check your inbox (and spam folder if necessary).`);
                
            } catch (error) {
                console.error('Error submitting email:', error);
                statusMessage.textContent = 'Error sending report.';
                submitEmailBtn.disabled = false;
                submitEmailBtn.textContent = 'Try Again';
                addMessage('bot', `Sorry, there was an issue sending your report. Please try again or contact support. Error: ${escapeHTML(error.message || 'Unknown error')}`);
            }
        }

        // --- INICIALIZAÇÃO COM ANIMAÇÃO --- 
        function startChatInterface() {
            console.log("Iniciando transição para o chat");
            introAnimationContainer.classList.add('hidden');
            // Muda fundo do body APÓS a animação e ANTES do chat aparecer
            document.body.style.background = 'linear-gradient(135deg, #1a1a1a 0%, #100f0f 100%)';
            chatContainer.classList.add('visible');
            document.body.style.overflow = 'auto';

            // Mostra a seleção de perfil inicial
            setTimeout(() => {
                 showProfileSelection();
            }, 500); // Pequeno atraso para efeito
        }

        // Inicia a transição após a animação (3s de animação + 0.5s de fade out)
        setTimeout(startChatInterface, 3500);

        // Event listeners para input e botões
        userInput.addEventListener('input', () => {
            // Auto-ajuste da altura do textarea
            userInput.style.height = 'auto';
            userInput.style.height = (userInput.scrollHeight) + 'px';
        });
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleUserInput();
            }
        });
        sendBtn.addEventListener('click', handleUserInput);
        finishBtn.addEventListener('click', getAnalysis);
        submitEmailBtn.addEventListener('click', submitEmail);

    </script>
</body>
</html>
