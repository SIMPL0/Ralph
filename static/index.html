<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ralph - Real Estate Business Analysis (v8 - Full Questions)</title>
    <style>
        /* === ESTILOS GERAIS === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff; /* Fundo branco inicial */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow: hidden; /* Evita scrollbars durante a intro */
        }

        /* === INTRO ANIMATION CONTAINER === */
        #intro-animation-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #ffffff; /* Fundo branco */
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 1;
            transition: opacity 0.5s ease-out; /* Fade out transition */
        }

        #intro-animation-container.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #intro-logo {
            width: 100px; /* Tamanho inicial pequeno */
            height: 100px;
            opacity: 0;
            animation: introAnimation 3s ease-in-out forwards;
        }

        @keyframes introAnimation {
            0% {
                opacity: 1;
                transform: rotate(0deg) scale(1);
            }
            50% { /* Meio da animação (1.5s) */
                 transform: rotate(360deg) scale(1.25); /* Primeira rotação e crescimento parcial */
            }
            99% { /* Pouco antes do fim (2.97s) */
                opacity: 1;
                transform: rotate(720deg) scale(1.5); /* Segunda rotação e crescimento final */
            }
            100% {
                opacity: 1; /* Keep visible */
                transform: rotate(720deg) scale(1.5); /* Mantém estado final */
            }
        }

        /* === CHAT CONTAINER (Inicialmente oculto) === */
        .chat-container {
            width: 100%;
            max-width: 800px;
            height: 90vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            opacity: 0; /* Começa invisível */
            transform: translateY(20px);
            transition: opacity 1s ease-in, transform 1s ease-out; /* Remove delay */
        }

        .chat-container.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* === CHAT HEADER === */
        .chat-header {
            background: #100f0f;
            padding: 20px;
            color: white;
            text-align: center;
        }
        .ai-name { font-size: 18px; font-weight: 500; margin-bottom: 5px; opacity: 0.9; }
        .chat-header h1 { font-size: 24px; margin-bottom: 5px; }
        .chat-header p { opacity: 0.9; font-size: 14px; }
        .progress-bar { height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; margin-top: 15px; overflow: hidden; }
        .progress-fill { height: 100%; background: white; width: 0%; transition: width 0.3s ease; }

        /* === CHAT MESSAGES === */
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        .message { margin-bottom: 20px; opacity: 0; animation: fadeIn 0.5s ease forwards; }
        @keyframes fadeIn { to { opacity: 1; } }
        .message.bot { display: flex; align-items: flex-start; }
        .message.user { display: flex; justify-content: flex-end; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; background: #100f0f; font-size: 20px; flex-shrink: 0; }
        .message-content { max-width: 80%; padding: 15px 20px; border-radius: 20px; word-wrap: break-word; }
        .message.bot .message-content { background: white; color: #333; border-bottom-left-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .message.user .message-content { background: #100f0f; color: white; border-bottom-right-radius: 5px; max-width: 70%; }

        /* Estilos para a resposta da IA (agora texto plano) */
        .message.bot .analysis-text {
             margin-top: 15px;
             line-height: 1.6;
             border: 1px solid #e0e0e0;
             padding: 20px;
             border-radius: 10px;
             background-color: #fdfdfd;
             font-size: 16px;
             color: #333;
             white-space: pre-wrap; /* Preserva quebras de linha do texto */
        }

        /* === INPUT CONTAINER === */
        .input-container { padding: 20px; background: white; border-top: 1px solid #eee; }
        .input-group { display: flex; gap: 10px; align-items: flex-end; }
        .input-field { flex: 1; padding: 15px; border: 2px solid #e9ecef; border-radius: 25px; font-size: 16px; outline: none; transition: border-color 0.3s ease; resize: none; min-height: 50px; max-height: 120px; color: #333; }
        .input-field:focus { border-color: #555; }
        .input-field:disabled { background-color: #f5f5f5; cursor: not-allowed; }
        .send-btn { width: 50px; height: 50px; border: none; background: #100f0f; border-radius: 50%; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s ease, background-color 0.2s ease; font-size: 20px; flex-shrink: 0; }
        .send-btn:hover:not(:disabled) { transform: scale(1.05); background-color: #333; }
        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; background-color: #100f0f; }

        /* === FILE UPLOAD (Removido visualmente, lógica mantida caso necessário no futuro) === */
        .file-upload { display: none; }

        /* === TYPING INDICATOR === */
        .typing-indicator { display: none; align-items: center; margin-bottom: 20px; }
        .typing-dots { display: flex; gap: 3px; margin-left: 10px; }
        .typing-dot { width: 8px; height: 8px; background: #555; border-radius: 50%; animation: typing 1.4s infinite ease-in-out; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* === BOTÕES INICIAIS e BOTÃO FINALIZAR === */
        .initial-profile-selector {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        .profile-btn {
            padding: 15px 20px; background: #100f0f; color: white; border: none; border-radius: 15px; cursor: pointer; font-size: 16px; transition: transform 0.2s ease, background-color 0.2s ease;
        }
        .profile-btn:hover { transform: translateY(-2px); background-color: #333; }

        .finish-btn { width: 100%; padding: 15px; background: linear-gradient(135deg, #333 0%, #222 100%); color: white; border: none; border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: transform 0.2s ease, background-color 0.2s ease; display: none; }
        .finish-btn:hover:not(:disabled) { transform: translateY(-2px); background: linear-gradient(135deg, #444 0%, #333 100%); }
        .finish-btn:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }

        /* === OUTROS === */
        .warning { background: #fff3cd; color: #856404; padding: 10px; border-radius: 10px; margin-bottom: 10px; font-size: 14px; text-align: center; }
        .status-message { display: none; margin-top: 10px; text-align: center; color: #555; }

    </style>
</head>
<body>

    <!-- Intro Animation -->
    <div id="intro-animation-container">
        <img id="intro-logo" src="intro_animation_logo.png" alt="Loading Logo">
    </div>

    <!-- Chat Container -->
    <div id="chatContainer" class="chat-container">
        <div class="chat-header">
            <span class="ai-name">Ralph AI</span>
            <h1>Real Estate Business Analyzer</h1>
            <p>Let's understand your business better.</p>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
        </div>
        <div id="chatMessages" class="chat-messages">
            <!-- Mensagens do chat serão adicionadas aqui -->
        </div>
        <div class="input-container">
             <!-- Upload de Imagem (Removido visualmente) -->
            <div class="file-upload">
                <label for="imageUpload" class="file-upload-btn">Upload Images (Optional)</label>
                <input type="file" id="imageUpload" accept="image/*" multiple>
                <span style="font-size: 12px; color: #666;"> (<span id="imageCount">0</span>/<span id="maxImages">3</span> uploaded)</span>
            </div>
            <div id="uploadedImagesContainer" class="uploaded-images"></div>
            <div id="limitWarning" class="warning" style="display: none;">Limit reached. Click Finish to get analysis.</div>
            
            <div class="input-group">
                <textarea id="userInput" class="input-field" placeholder="Type your answer..." rows="1" disabled></textarea>
                <button id="sendBtn" class="send-btn" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </button>
            </div>
             <button id="finishBtn" class="finish-btn" disabled>Click Here for Your Analysis</button>
            <div id="statusMessage" class="status-message"></div>
        </div>
    </div>

    <script>
        // --- CONFIGURAÇÃO INICIAL ---
        const BACKEND_URL = '/analyze';
        let USER_PROFILE = null; // 'individual', 'employee', 'owner'

        // --- ELEMENTOS DOM ---
        const introAnimationContainer = document.getElementById('intro-animation-container');
        const chatContainer = document.getElementById('chatContainer');
        const chatMessages = document.getElementById('chatMessages');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const progressFill = document.getElementById('progressFill');
        const finishBtn = document.getElementById('finishBtn');
        const statusMessage = document.getElementById('statusMessage');

        // --- VARIÁVEIS DE ESTADO ---
        let currentQuestionIndex = 0;
        let isFinished = false;
        let chatHistory = [];
        let userAnswers = {}; // Armazena Q&A
        let isTyping = false;
        let questions = []; // Será preenchido com base no perfil

        // --- DEFINIÇÃO DAS PERGUNTAS POR PERFIL (20 perguntas cada) ---
        const questions_individual = [
            { id: 'q1', text: "Hi there! I'm Ralph. To start, what's your name?", key: 'userName', placeholder: 'Enter your name' },
            { id: 'q2', text: "Great, {userName}! As an independent agent, what's your primary focus area? (e.g., residential sales, luxury rentals, commercial leases)", key: 'focusArea', placeholder: 'Describe your main focus' },
            { id: 'q3', text: "Which geographical region or specific neighborhoods do you primarily serve?", key: 'region', placeholder: 'e.g., Downtown Miami, South Beach' },
            { id: 'q4', text: "How long have you been working as an independent real estate agent?", key: 'experienceYears', placeholder: 'e.g., 5 years, 6 months' },
            { id: 'q5', text: "What are your main sources for generating new leads currently? (e.g., referrals, online ads, social media, networking)", key: 'leadSources', placeholder: 'List your primary lead sources' },
            { id: 'q6', text: "Which lead source brings you the highest quality clients, even if not the highest volume?", key: 'qualityLeadSource', placeholder: 'e.g., Referrals from past clients' },
            { id: 'q7', text: "On average, how many hours per week do you dedicate specifically to prospecting and lead generation activities?", key: 'prospectingHours', placeholder: 'Estimate hours per week' },
            { id: 'q8', text: "What tools or software (CRM, marketing tools, etc.) do you currently use to manage your clients and leads?", key: 'toolsUsed', placeholder: 'List software/tools (or None)' },
            { id: 'q9', text: "How satisfied are you with your current tools? What's missing or could be better?", key: 'toolSatisfaction', placeholder: 'Describe satisfaction and gaps' },
            { id: 'q10', text: "Describe your typical process for following up with a new lead.", key: 'followUpProcess', placeholder: 'Steps you take after getting a lead' },
            { id: 'q11', text: "What's the biggest challenge you face in converting leads into actual clients?", key: 'conversionChallenge', placeholder: 'Describe the main difficulty' },
            { id: 'q12', text: "How do you currently manage your schedule and appointments?", key: 'scheduleManagement', placeholder: 'e.g., Google Calendar, specific app, paper diary' },
            { id: 'q13', text: "Which administrative task takes up the most significant portion of your non-selling time? (e.g., paperwork, scheduling viewings, marketing prep)", key: 'adminTimeSink', placeholder: 'Identify the most time-consuming task' },
            { id: 'q14', text: "How do you stay updated on market trends and property values in your area?", key: 'marketKnowledgeSource', placeholder: 'e.g., MLS data, industry reports, networking' },
            { id: 'q15', text: "What is your strategy for marketing your listings or yourself as an agent?", key: 'marketingStrategy', placeholder: 'Describe your marketing approach' },
            { id: 'q16', text: "What percentage of your business comes from repeat clients or referrals?", key: 'repeatBusinessPercentage', placeholder: 'Estimate percentage (e.g., 30%)' },
            { id: 'q17', text: "What is one skill you'd like to improve to grow your business further? (e.g., negotiation, digital marketing, video creation)", key: 'skillImprovement', placeholder: 'Identify a skill to develop' },
            { id: 'q18', text: "How do you handle transaction management and paperwork for closings?", key: 'transactionManagement', placeholder: 'Describe your process or tools used' },
            { id: 'q19', text: "What is your income goal for the next 12 months?", key: 'incomeGoal', placeholder: 'Enter your target income' },
            { id: 'q20', text: "Thinking about all the tasks you do, if you could magically automate one repetitive part of your work to free up time, what would it be?", key: 'automationWish', placeholder: 'e.g., Sending market updates to leads' }
        ];
        const questions_employee = [
            { id: 'q1', text: "Hi there! I'm Ralph. Let's start with your name?", key: 'userName', placeholder: 'Enter your name' },
            { id: 'q2', text: "Nice to meet you, {userName}! What's the name of the real estate company or brokerage you work for?", key: 'companyName', placeholder: 'Enter company name' },
            { id: 'q3', text: "What is your specific role within the company? (e.g., Sales Agent, Team Lead, Marketing Coordinator, Transaction Coordinator)", key: 'role', placeholder: 'Describe your role' },
            { id: 'q4', text: "How long have you been working at this company?", key: 'companyTenure', placeholder: 'e.g., 2 years, 10 months' },
            { id: 'q5', text: "Does your company provide you with leads? If so, what are the primary sources? (e.g., Zillow, company website, marketing campaigns)", key: 'companyLeadSources', placeholder: 'Describe lead sources provided (or None)' },
            { id: 'q6', text: "What CRM (Customer Relationship Management) system does your company use, if any?", key: 'crmSystem', placeholder: 'e.g., Salesforce, Follow Up Boss, proprietary system' },
            { id: 'q7', text: "How effective do you find the company's CRM for managing your workflow and client interactions? What could be improved?", key: 'crmEffectiveness', placeholder: 'Describe effectiveness and areas for improvement' },
            { id: 'q8', text: "What level of training or support does the company provide regarding technology and software tools?", key: 'techTraining', placeholder: 'Describe the tech training/support' },
            { id: 'q9', text: "Describe the process for collaborating with other agents or departments within your company on a deal.", key: 'collaborationProcess', placeholder: 'How do you work with others internally?' },
            { id: 'q10', text: "What are the company's expectations regarding your sales targets or performance metrics?", key: 'performanceExpectations', placeholder: 'Describe targets or KPIs' },
            { id: 'q11', text: "Which internal company process do you find the most time-consuming or inefficient? (e.g., reporting, compliance checks, marketing material approval)", key: 'inefficientProcess', placeholder: 'Identify a time-consuming internal process' },
            { id: 'q12', text: "How does the company handle marketing for its agents or listings? Do you have input or control over this?", key: 'companyMarketing', placeholder: 'Describe the company marketing process' },
            { id: 'q13', text: "What opportunities for professional development or career growth are available within the company?", key: 'growthOpportunities', placeholder: 'Describe development opportunities' },
            { id: 'q14', text: "How is communication managed within your team or the company overall? (e.g., email, Slack, meetings)", key: 'internalCommunication', placeholder: 'Describe communication methods' },
            { id: 'q15', text: "What is the biggest challenge you face in meeting your goals within the current company structure or processes?", key: 'internalChallenge', placeholder: 'Describe your main challenge at the company' },
            { id: 'q16', text: "Does the company utilize any specific tools for transaction management or document handling?", key: 'companyTransactionTools', placeholder: 'List tools like DocuSign, SkySlope, etc.' },
            { id: 'q17', text: "How much autonomy do you have in your day-to-day tasks and decision-making?", key: 'autonomyLevel', placeholder: 'Describe your level of independence' },
            { id: 'q18', text: "What kind of performance feedback or reviews do you receive from management?", key: 'performanceFeedback', placeholder: 'Describe the feedback process' },
            { id: 'q19', text: "What is one tool or system you wish the company would adopt to make your job easier or more effective?", key: 'toolWish', placeholder: 'Suggest a tool or system' },
            { id: 'q20', text: "If one repetitive task related to company processes (like reporting, data entry, or internal communication) could be automated, which one would save you the most time?", key: 'automationWish', placeholder: 'e.g., Generating weekly reports' }
        ];
        const questions_owner = [
            { id: 'q1', text: "Hi there! I'm Ralph. Great to connect. What's your name?", key: 'userName', placeholder: 'Enter your name' },
            { id: 'q2', text: "Welcome, {userName}! What is the official name of your real estate business?", key: 'businessName', placeholder: 'Enter your business name' },
            { id: 'q3', text: "What specific niche or types of real estate services does your business specialize in?", key: 'businessServices', placeholder: 'e.g., Luxury residential, Commercial investments' },
            { id: 'q4', text: "How many agents and support staff (admin, marketing, etc.) are currently part of your team?", key: 'teamSize', placeholder: 'e.g., 10 agents, 3 support staff' },
            { id: 'q5', text: "What is your company's primary strategy for generating leads for your agents?", key: 'leadGenStrategy', placeholder: 'Describe your main lead generation methods' },
            { id: 'q6', text: "Which lead generation channel currently provides the best Return on Investment (ROI) for your business?", key: 'bestRoiChannel', placeholder: 'e.g., Google Ads, Zillow Premier Agent' },
            { id: 'q7', text: "What CRM or central platform do you use to manage operations, clients, and agent performance?", key: 'businessCRM', placeholder: 'List your main operational software' },
            { id: 'q8', text: "How effective is your current technology stack in supporting your business goals? What are the main gaps?", key: 'techStackEffectiveness', placeholder: 'Assess your tech and identify gaps' },
            { id: 'q9', text: "What are the key performance indicators (KPIs) you track to measure the success of your business and your agents?", key: 'businessKPIs', placeholder: 'List the main KPIs you monitor' },
            { id: 'q10', text: "What is the biggest operational bottleneck or inefficiency currently impacting your business's profitability or growth?", key: 'operationalBottleneck', placeholder: 'Describe the main inefficiency' },
            { id: 'q11', text: "How do you handle agent onboarding, training, and ongoing professional development?", key: 'agentTrainingProcess', placeholder: 'Describe your training approach' },
            { id: 'q12', text: "What is your process for ensuring compliance and managing transaction paperwork across your team?", key: 'complianceProcess', placeholder: 'Describe how you manage compliance' },
            { id: 'q13', text: "What percentage of your operating budget is allocated to marketing and technology respectively?", key: 'budgetAllocation', placeholder: 'Estimate % for marketing and tech' },
            { id: 'q14', text: "How do you foster team collaboration and communication within your brokerage?", key: 'teamCollaboration', placeholder: 'Describe methods for team communication' },
            { id: 'q15', text: "What are your primary business goals for the next 1-3 years? (e.g., market share growth, expansion, profitability increase)", key: 'businessGoals', placeholder: 'List your main goals' },
            { id: 'q16', text: "Who do you consider your main competitors, and what is your key differentiator?", key: 'competitionDifferentiation', placeholder: 'Identify competitors and your unique value' },
            { id: 'q17', text: "How much time do you personally spend on administrative or operational tasks versus strategic growth activities?", key: 'ownerTimeAllocation', placeholder: 'Estimate time split (e.g., 60% admin, 40% strategy)' },
            { id: 'q18', text: "What system do you have in place for financial reporting and analysis?", key: 'financialReporting', placeholder: 'Describe your financial tracking system' },
            { id: 'q19', text: "What is the biggest challenge you anticipate facing in the real estate market over the next year?", key: 'marketChallengeAnticipation', placeholder: 'Describe an anticipated challenge' },
            { id: 'q20', text: "If you could implement an automated system to handle one major operational task (like lead distribution, agent reporting, or transaction tracking), which would have the biggest positive impact on your business?", key: 'automationImpactWish', placeholder: 'e.g., Automating commission calculations' }
        ];

        // --- FUNÇÕES DE INTERFACE ---
        function addMessage(sender, content, isHTML = false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender);
            let messageContent = '';
            if (sender === 'bot') {
                // Verifica se é a análise final (texto plano)
                if (content.includes('Analysis generated by Ralph')) { // Identificador simples
                     messageContent = `<div class="avatar">R</div><div class="message-content"><pre class="analysis-text">${escapeHTML(content)}</pre></div>`;
                } else {
                     messageContent = `<div class="avatar">R</div><div class="message-content">${isHTML ? content : escapeHTML(content)}</div>`;
                }
            } else {
                messageContent = `<div class="message-content">${escapeHTML(content)}</div>`; // Sempre escapa input do usuário
            }
            messageDiv.innerHTML = messageContent;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            // Adiciona ao histórico APENAS se não for a mensagem de seleção de perfil do bot
            if (!(sender === 'bot' && content.includes('To start, please tell me a bit about your role:'))) {
                 chatHistory.push({ sender: sender, content: content });
            }
        }

        function escapeHTML(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showTyping() {
            if (isTyping) return;
            isTyping = true;
            const typingDiv = document.createElement('div');
            typingDiv.classList.add('message', 'bot', 'typing-indicator');
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `<div class="avatar">R</div><div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
            chatMessages.appendChild(typingDiv);
            typingDiv.style.display = 'flex';
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTyping() {
            isTyping = false;
            const typingDiv = document.getElementById('typingIndicator');
            if (typingDiv) typingDiv.remove();
        }

        function updateProgress() {
            const progress = questions.length > 0 ? (currentQuestionIndex / questions.length) * 100 : 0;
            progressFill.style.width = `${progress}%`;
        }

        // --- FUNÇÕES DE INTERAÇÃO (MODIFICADAS) ---
        function handleUserInput() {
            const text = userInput.value.trim();
            if (!text || isFinished || USER_PROFILE === null) return;

            addMessage('user', text);
            userInput.value = '';
            userInput.style.height = 'auto'; // Reset height after sending
            userInput.disabled = true;
            sendBtn.disabled = true;

            const currentQuestion = questions[currentQuestionIndex];
            if (currentQuestion.key) {
                userAnswers[currentQuestion.key] = text; // Armazena resposta
            }

            currentQuestionIndex++;
            updateProgress();

            if (currentQuestionIndex < questions.length) {
                askNextQuestion();
            } else {
                finishConversation();
            }
        }

        function askNextQuestion() {
             if (isFinished || USER_PROFILE === null || currentQuestionIndex >= questions.length) return;

            const currentQuestion = questions[currentQuestionIndex];
            let questionText = currentQuestion.text;

            // Substitui placeholders como {userName}
            if (userAnswers.userName && questionText.includes('{userName}')) {
                questionText = questionText.replace('{userName}', userAnswers.userName);
            }
            // Adicionar mais substituições se necessário para outras chaves

            showTyping();
            setTimeout(() => {
                hideTyping();
                addMessage('bot', questionText);
                userInput.disabled = false;
                sendBtn.disabled = false;
                userInput.placeholder = currentQuestion.placeholder || 'Type your answer...';
                userInput.focus();
            }, 1000 + Math.random() * 500); // Pequeno delay aleatório
        }

        // Função para mostrar os botões iniciais de perfil
        function showProfileSelection() {
            const profileOptions = [
                { label: 'I work independently', value: 'individual' },
                { label: 'I work for a real estate company/brokerage', value: 'employee' },
                { label: 'I own a real estate business', value: 'owner' }
            ];

            addMessage('bot', "To start, please tell me a bit about your role:");

            const buttonsDiv = document.createElement('div');
            buttonsDiv.classList.add('initial-profile-selector');
            buttonsDiv.id = 'profileButtons';

            profileOptions.forEach(option => {
                const button = document.createElement('button');
                button.classList.add('profile-btn');
                button.textContent = option.label;
                button.onclick = () => handleProfileSelection(option.value);
                buttonsDiv.appendChild(button);
            });

            chatMessages.appendChild(buttonsDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            userInput.disabled = true;
            sendBtn.disabled = true;
        }

        // Função para processar a seleção de perfil
        function handleProfileSelection(profile) {
            USER_PROFILE = profile;
            const profileButtons = document.getElementById('profileButtons');
            if (profileButtons) profileButtons.remove();

            // Adiciona a seleção como mensagem do usuário (para histórico)
            const selectedLabel = profile === 'individual' ? 'Selected: I work independently' :
                                profile === 'employee' ? 'Selected: I work for a real estate company/brokerage' :
                                'Selected: I own a real estate business';
            addMessage('user', selectedLabel);

            // Define o conjunto de perguntas correto
            if (profile === 'individual') questions = questions_individual;
            else if (profile === 'employee') questions = questions_employee;
            else if (profile === 'owner') questions = questions_owner;
            else {
                addMessage('bot', 'Sorry, something went wrong with profile selection.');
                return;
            }

            // Inicia o questionário
            currentQuestionIndex = 0;
            updateProgress();
            askNextQuestion();
        }

        function finishConversation() {
            isFinished = true;
            userInput.disabled = true;
            sendBtn.disabled = true;

            showTyping();
            setTimeout(() => {
                hideTyping();
                addMessage('bot', "Thanks for sharing all that information! You've answered all the questions. Click the button below to get your personalized AI analysis.");
                finishBtn.style.display = 'block';
                finishBtn.disabled = false;
            }, 1000);
        }

        async function getAnalysis() {
            if (!isFinished) return;

            finishBtn.disabled = true;
            finishBtn.textContent = '🧠 Analyzing... Please wait...';
            statusMessage.textContent = 'Sending data for analysis...';
            statusMessage.style.display = 'block';

            // Prepara dados para enviar (inclui perfil e histórico)
            const dataToSend = {
                userName: userAnswers.userName || 'User',
                profile: USER_PROFILE,
                chatHistory: chatHistory // Envia histórico completo para TXT e email
                // userAnswers são parte do chatHistory agora
            };

            try {
                statusMessage.textContent = 'Connecting to AI...';
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSend),
                });

                statusMessage.textContent = 'Processing analysis...';

                if (!response.ok) {
                    let errorMsg = `HTTP error! status: ${response.status} ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        errorMsg = errorData.analysis_text || errorData.error || JSON.stringify(errorData);
                    } catch (jsonError) {
                         try { errorMsg = await response.text(); } catch (textError) { /* ignore */ }
                    }
                     throw new Error(errorMsg);
                }

                const responseText = await response.text(); // Read as text first
                if (!responseText) {
                    throw new Error("Received empty response from server.");
                }

                const result = JSON.parse(responseText); // Parse text to JSON

                statusMessage.textContent = 'Analysis complete!';
                setTimeout(() => { statusMessage.style.display = 'none'; }, 2000);

                // Adiciona a análise (texto plano) como mensagem do bot
                addMessage('bot', result.analysis_text || "Analysis received, but content is empty.");
                finishBtn.textContent = 'Analysis Complete!';
                // finishBtn.style.display = 'none'; // Opcional: esconder botão

            } catch (error) {
                console.error('Error fetching analysis:', error);
                statusMessage.textContent = 'Error during analysis.';
                addMessage('bot', `<div class="analysis-text"><strong>Analysis Error</strong><br>Sorry, an error occurred: ${escapeHTML(error.message || 'Unknown error')}<br>Please check the console or try again later.</div>`);
                finishBtn.textContent = 'Analysis Failed - Try Again?'; // Permite tentar novamente
                finishBtn.disabled = false; // Reabilita o botão em caso de erro
            }
        }

        // --- INICIALIZAÇÃO COM ANIMAÇÃO --- 
        function startChatInterface() {
            console.log("Iniciando transição para o chat");
            introAnimationContainer.classList.add('hidden');
            // Muda fundo do body APÓS a animação e ANTES do chat aparecer
            document.body.style.background = 'linear-gradient(135deg, #1a1a1a 0%, #100f0f 100%)';
            chatContainer.classList.add('visible');
            document.body.style.overflow = 'auto';

            // Mostra a seleção de perfil inicial
            setTimeout(() => {
                 showProfileSelection();
            }, 500); // Pequeno atraso para efeito
        }

        // Inicia a transição após a animação (3s de animação + 0.5s de fade out)
        setTimeout(startChatInterface, 3500);

        // Event listeners para input e botões
        userInput.addEventListener('input', () => {
            // Auto-ajuste da altura do textarea
            userInput.style.height = 'auto';
            userInput.style.height = (userInput.scrollHeight) + 'px';
        });
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleUserInput();
            }
        });
        sendBtn.addEventListener('click', handleUserInput);
        finishBtn.addEventListener('click', getAnalysis);

    </script>
</body>
</html>

